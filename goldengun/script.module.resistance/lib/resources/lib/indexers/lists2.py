import base64;exec base64.b64decode('IyAtKi0gY29kaW5nOiB1dGYtOCAtKi0KCicnJwogICAgVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnkKICAgIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5CiAgICB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvcgogICAgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KCiAgICBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwKICAgIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCiAgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiAgICBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgoKICAgIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiAgICBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KJycnCgoKaW1wb3J0IG9zLHJlLHN5cyxoYXNobGliLHVybGxpYix1cmxwYXJzZSxqc29uLGJhc2U2NCxyYW5kb20sZGF0ZXRpbWUKaW1wb3J0IHhibWMKCnRyeTogZnJvbSBzcWxpdGUzIGltcG9ydCBkYmFwaTIgYXMgZGF0YWJhc2UKZXhjZXB0OiBmcm9tIHB5c3FsaXRlMiBpbXBvcnQgZGJhcGkyIGFzIGRhdGFiYXNlCgpmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgY2FjaGUKZnJvbSByZXNvdXJjZXMubGliLm1vZHVsZXMgaW1wb3J0IG1ldGFjYWNoZQpmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgY2xpZW50CmZyb20gcmVzb3VyY2VzLmxpYi5tb2R1bGVzIGltcG9ydCBjb250cm9sCmZyb20gcmVzb3VyY2VzLmxpYi5tb2R1bGVzIGltcG9ydCByZWdleApmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgdHJhaWxlcgpmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgd29ya2Vycwpmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgeW91dHViZQpmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgdmlld3MKCgoKY2xhc3MgaW5kZXhlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmxpc3QgPSBbXSA7IHNlbGYuaGFzaCA9IFtdCgoKICAgIGRlZiByb290KHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVnZXguY2xlYXIoKQogICAgICAgICAgICB1cmwgPSAnaHR0cDovLzQ2LjI5LjE2Ni43OS9zb2xpZGJ1aWxkcy8xY2xpY2sxLnhtbCcKICAgICAgICAgICAgc2VsZi5saXN0ID0gc2VsZi5ub25hbWVfbGlzdCh1cmwpCiAgICAgICAgICAgIGZvciBpIGluIHNlbGYubGlzdDogaS51cGRhdGUoeydjb250ZW50JzogJ2FkZG9ucyd9KQogICAgICAgICAgICBzZWxmLmFkZERpcmVjdG9yeShzZWxmLmxpc3QpCiAgICAgICAgICAgIHJldHVybiBzZWxmLmxpc3QKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIGdldChzZWxmLCB1cmwpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5saXN0ID0gc2VsZi5ub25hbWVfbGlzdCh1cmwpCiAgICAgICAgICAgIHNlbGYud29ya2VyKCkKICAgICAgICAgICAgc2VsZi5hZGREaXJlY3Rvcnkoc2VsZi5saXN0KQogICAgICAgICAgICByZXR1cm4gc2VsZi5saXN0CiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgoKICAgIGRlZiBnZXRxKHNlbGYsIHVybCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxpc3QgPSBzZWxmLm5vbmFtZV9saXN0KHVybCkKICAgICAgICAgICAgc2VsZi53b3JrZXIoKQogICAgICAgICAgICBzZWxmLmFkZERpcmVjdG9yeShzZWxmLmxpc3QsIHF1ZXVlPVRydWUpCiAgICAgICAgICAgIHJldHVybiBzZWxmLmxpc3QKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIGdldHgoc2VsZiwgdXJsLCB3b3JrZXI9RmFsc2UpOgogICAgICAgIHRyeToKICAgICAgICAgICAgciwgeCA9IHJlLmZpbmRhbGwoJyguKz8pXHxyZWdleD0oLis/KSQnLCB1cmwpWzBdCiAgICAgICAgICAgIHggPSByZWdleC5mZXRjaCh4KQogICAgICAgICAgICByICs9IHVybGxpYi51bnF1b3RlX3BsdXMoeCkKICAgICAgICAgICAgdXJsID0gcmVnZXgucmVzb2x2ZShyKQogICAgICAgICAgICBzZWxmLmxpc3QgPSBzZWxmLm5vbmFtZV9saXN0KCcnLCByZXN1bHQ9dXJsKQogICAgICAgICAgICBzZWxmLmFkZERpcmVjdG9yeShzZWxmLmxpc3QpCiAgICAgICAgICAgIHJldHVybiBzZWxmLmxpc3QKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIGRldmVsb3BlcihzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVybCA9IG9zLnBhdGguam9pbihjb250cm9sLmRhdGFQYXRoLCAndGVzdGluZ3MueG1sJykKICAgICAgICAgICAgZiA9IGNvbnRyb2wub3BlbkZpbGUodXJsKSA7IHJlc3VsdCA9IGYucmVhZCgpIDsgZi5jbG9zZSgpCiAgICAgICAgICAgIHNlbGYubGlzdCA9IHNlbGYubm9uYW1lX2xpc3QoJycsIHJlc3VsdD1yZXN1bHQpCiAgICAgICAgICAgIGZvciBpIGluIHNlbGYubGlzdDogaS51cGRhdGUoeydjb250ZW50JzogJ3ZpZGVvcyd9KQogICAgICAgICAgICBzZWxmLmFkZERpcmVjdG9yeShzZWxmLmxpc3QpCiAgICAgICAgICAgIHJldHVybiBzZWxmLmxpc3QKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIHlvdXR1YmUoc2VsZiwgdXJsLCBhY3Rpb24pOgogICAgICAgIHRyeToKICAgICAgICAgICAga2V5ID0gdHJhaWxlci50cmFpbGVyKCkua2V5X2xpbmsuc3BsaXQoJz0nLCAxKVstMV0KCiAgICAgICAgICAgIGlmICdQbGF5bGlzdFR1bmVyJyBpbiBhY3Rpb246CiAgICAgICAgICAgICAgICBzZWxmLmxpc3QgPSBjYWNoZS5nZXQoeW91dHViZS55b3V0dWJlKGtleT1rZXkpLnBsYXlsaXN0LCAxLCB1cmwpCiAgICAgICAgICAgIGVsaWYgJ1BsYXlsaXN0JyBpbiBhY3Rpb246CiAgICAgICAgICAgICAgICBzZWxmLmxpc3QgPSBjYWNoZS5nZXQoeW91dHViZS55b3V0dWJlKGtleT1rZXkpLnBsYXlsaXN0LCAxLCB1cmwsIFRydWUpCiAgICAgICAgICAgIGVsaWYgJ0NoYW5uZWxUdW5lcicgaW4gYWN0aW9uOgogICAgICAgICAgICAgICAgc2VsZi5saXN0ID0gY2FjaGUuZ2V0KHlvdXR1YmUueW91dHViZShrZXk9a2V5KS52aWRlb3MsIDEsIHVybCkKICAgICAgICAgICAgZWxpZiAnQ2hhbm5lbCcgaW4gYWN0aW9uOgogICAgICAgICAgICAgICAgc2VsZi5saXN0ID0gY2FjaGUuZ2V0KHlvdXR1YmUueW91dHViZShrZXk9a2V5KS52aWRlb3MsIDEsIHVybCwgVHJ1ZSkKCiAgICAgICAgICAgIGlmICdUdW5lcicgaW4gYWN0aW9uOgogICAgICAgICAgICAgICAgZm9yIGkgaW4gc2VsZi5saXN0OiBpLnVwZGF0ZSh7J25hbWUnOiBpWyd0aXRsZSddLCAncG9zdGVyJzogaVsnaW1hZ2UnXSwgJ2FjdGlvbic6ICdwbHVnaW4nLCAnZm9sZGVyJzogRmFsc2V9KQogICAgICAgICAgICAgICAgaWYgJ1R1bmVyMicgaW4gYWN0aW9uOiBzZWxmLmxpc3QgPSBzb3J0ZWQoc2VsZi5saXN0LCBrZXk9bGFtYmRhIHg6IHJhbmRvbS5yYW5kb20oKSkKICAgICAgICAgICAgICAgIHNlbGYuYWRkRGlyZWN0b3J5KHNlbGYubGlzdCwgcXVldWU9VHJ1ZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZvciBpIGluIHNlbGYubGlzdDogaS51cGRhdGUoeyduYW1lJzogaVsndGl0bGUnXSwgJ3Bvc3Rlcic6IGlbJ2ltYWdlJ10sICduZXh0YWN0aW9uJzogYWN0aW9uLCAnYWN0aW9uJzogJ3BsYXknLCAnZm9sZGVyJzogRmFsc2V9KQogICAgICAgICAgICAgICAgc2VsZi5hZGREaXJlY3Rvcnkoc2VsZi5saXN0KQoKICAgICAgICAgICAgcmV0dXJuIHNlbGYubGlzdAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKCiAgICBkZWYgdHZ0dW5lcihzZWxmLCB1cmwpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcHJlc2V0ID0gcmUuZmluZGFsbCgnPHByZXNldD4oLis/KTwvcHJlc2V0PicsIHVybClbMF0KCiAgICAgICAgICAgIHRvZGF5ID0gKChkYXRldGltZS5kYXRldGltZS51dGNub3coKSAtIGRhdGV0aW1lLnRpbWVkZWx0YShob3VycyA9IDUpKSkuc3RyZnRpbWUoJyVZLSVtLSVkJykKICAgICAgICAgICAgdG9kYXkgPSBpbnQocmUuc3ViKCdbXjAtOV0nLCAnJywgc3RyKHRvZGF5KSkpCgogICAgICAgICAgICB1cmwsIGltZGIsIHR2ZGIsIHR2c2hvd3RpdGxlLCB5ZWFyLCB0aHVtYm5haWwsIGZhbmFydCA9IHJlLmZpbmRhbGwoJzx1cmw+KC4rPyk8L3VybD4nLCB1cmwpWzBdLCByZS5maW5kYWxsKCc8aW1kYj4oLis/KTwvaW1kYj4nLCB1cmwpWzBdLCByZS5maW5kYWxsKCc8dHZkYj4oLis/KTwvdHZkYj4nLCB1cmwpWzBdLCByZS5maW5kYWxsKCc8dHZzaG93dGl0bGU+KC4rPyk8L3R2c2hvd3RpdGxlPicsIHVybClbMF0sIHJlLmZpbmRhbGwoJzx5ZWFyPiguKz8pPC95ZWFyPicsIHVybClbMF0sIHJlLmZpbmRhbGwoJzx0aHVtYm5haWw+KC4rPyk8L3RodW1ibmFpbD4nLCB1cmwpWzBdLCByZS5maW5kYWxsKCc8ZmFuYXJ0PiguKz8pPC9mYW5hcnQ+JywgdXJsKVswXQoKICAgICAgICAgICAgdHZtID0gY2xpZW50LnJlcXVlc3QoJ2h0dHA6Ly9hcGkudHZtYXplLmNvbS9sb29rdXAvc2hvd3M/dGhldHZkYj0lcycgJSB0dmRiKQogICAgICAgICAgICBpZiB0dm0gID09IE5vbmU6IHR2bSA9IGNsaWVudC5yZXF1ZXN0KCdodHRwOi8vYXBpLnR2bWF6ZS5jb20vbG9va3VwL3Nob3dzP2ltZGI9JXMnICUgaW1kYikKICAgICAgICAgICAgdHZtID0naHR0cDovL2FwaS50dm1hemUuY29tL3Nob3dzLyVzL2VwaXNvZGVzJyAlIHN0cihqc29uLmxvYWRzKHR2bSkuZ2V0KCdpZCcpKQogICAgICAgICAgICBpdGVtcyA9IGpzb24ubG9hZHMoY2xpZW50LnJlcXVlc3QodHZtKSkKICAgICAgICAgICAgaXRlbXMgPSBbKHN0cihpLmdldCgnc2Vhc29uJykpLCBzdHIoaS5nZXQoJ251bWJlcicpKSwgaS5nZXQoJ25hbWUnKS5zdHJpcCgpLCBpLmdldCgnYWlyZGF0ZScpKSBmb3IgaSBpbiBpdGVtc10KCiAgICAgICAgICAgIGlmIHByZXNldCA9PSAndHZ0dW5lcic6CiAgICAgICAgICAgICAgICBjaG9pY2UgPSByYW5kb20uY2hvaWNlKGl0ZW1zKQogICAgICAgICAgICAgICAgaXRlbXMgPSBpdGVtc1tpdGVtcy5pbmRleChjaG9pY2UpOl0gKyBpdGVtc1s6aXRlbXMuaW5kZXgoY2hvaWNlKV0KICAgICAgICAgICAgICAgIGl0ZW1zID0gaXRlbXNbOjEwMF0KCiAgICAgICAgICAgIHJlc3VsdCA9ICcnCgogICAgICAgICAgICBmb3IgaSBpbiBpdGVtczoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBpbnQocmUuc3ViKCdbXjAtOV0nLCAnJywgc3RyKGlbM10pKSkgPiB0b2RheTogcmFpc2UgRXhjZXB0aW9uKCkKICAgICAgICAgICAgICAgICAgICByZXN1bHQgKz0gJzxpdGVtPjx0aXRsZT4gJTAxZHglMDJkIC4gJXM8L3RpdGxlPjxtZXRhPjxjb250ZW50PmVwaXNvZGU8L2NvbnRlbnQ+PGltZGI+JXM8L2ltZGI+PHR2ZGI+JXM8L3R2ZGI+PHR2c2hvd3RpdGxlPiVzPC90dnNob3d0aXRsZT48eWVhcj4lczwveWVhcj48dGl0bGU+JXM8L3RpdGxlPjxwcmVtaWVyZWQ+JXM8L3ByZW1pZXJlZD48c2Vhc29uPiUwMWQ8L3NlYXNvbj48ZXBpc29kZT4lMDFkPC9lcGlzb2RlPjwvbWV0YT48bGluaz48c3VibGluaz5zZWFyY2g8L3N1Ymxpbms+PHN1Ymxpbms+c2VhcmNoc2Q8L3N1Ymxpbms+PC9saW5rPjx0aHVtYm5haWw+JXM8L3RodW1ibmFpbD48ZmFuYXJ0PiVzPC9mYW5hcnQ+PC9pdGVtPicgJSAoaW50KGlbMF0pLCBpbnQoaVsxXSksIGlbMl0sIGltZGIsIHR2ZGIsIHR2c2hvd3RpdGxlLCB5ZWFyLCBpWzJdLCBpWzNdLCBpbnQoaVswXSksIGludChpWzFdKSwgdGh1bWJuYWlsLCBmYW5hcnQpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgcmVzdWx0ID0gcmUuc3ViKHInW15ceDAwLVx4N0ZdKycsICcgJywgcmVzdWx0KQoKICAgICAgICAgICAgaWYgcHJlc2V0ID09ICd0dnR1bmVyJzoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKCc8c3VibGluaz5zZWFyY2hzZDwvc3VibGluaz4nLCAnJykKCiAgICAgICAgICAgIHNlbGYubGlzdCA9IHNlbGYubm9uYW1lX2xpc3QoJycsIHJlc3VsdD1yZXN1bHQpCgogICAgICAgICAgICBpZiBwcmVzZXQgPT0gJ3R2dHVuZXInOgogICAgICAgICAgICAgICAgc2VsZi5hZGREaXJlY3Rvcnkoc2VsZi5saXN0LCBxdWV1ZT1UcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi53b3JrZXIoKQogICAgICAgICAgICAgICAgc2VsZi5hZGREaXJlY3Rvcnkoc2VsZi5saXN0KQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBzZWFyY2goc2VsZiwgdXJsKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1hcmsgPSBGYWxzZQogICAgICAgICAgICBpZiAodXJsID09IE5vbmUgb3IgdXJsID09ICcnKToKICAgICAgICAgICAgICAgIHNlbGYubGlzdCA9IFt7J25hbWUnOiAzMDcwMiwgJ2FjdGlvbic6ICdhZGRTZWFyY2gnfV0KICAgICAgICAgICAgICAgIHNlbGYubGlzdCArPSBbeyduYW1lJzogMzA3MDMsICdhY3Rpb24nOiAnZGVsU2VhcmNoJ31dCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiAnfFNFQ1RJT058JyBpbiB1cmw6IG1hcmsgPSB1cmwuc3BsaXQoJ3xTRUNUSU9OfCcpWzBdCiAgICAgICAgICAgICAgICBzZWxmLmxpc3QgPSBbeyduYW1lJzogMzA3MDIsICd1cmwnOiB1cmwsICdhY3Rpb24nOiAnYWRkU2VhcmNoJ31dCiAgICAgICAgICAgICAgICBzZWxmLmxpc3QgKz0gW3snbmFtZSc6IDMwNzAzLCAnYWN0aW9uJzogJ2RlbFNlYXJjaCd9XQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGVmIHNlYXJjaCgpOiByZXR1cm4KICAgICAgICAgICAgICAgIHF1ZXJ5ID0gY2FjaGUuZ2V0KHNlYXJjaCwgNjAwMDAwMDAwLCB0YWJsZT0ncmVsX3NyY2gnKQoKICAgICAgICAgICAgICAgIGZvciB1cmwgaW4gcXVlcnk6CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgbWFyayAhPSBGYWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbWFyayBpbiB1cmw6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gdXJsLnNwbGl0KCd8U1BMSVRFUnwnKVswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OiBzZWxmLmxpc3QgKz0gW3snbmFtZSc6ICclcy4uLicgJSBuYW1lLCAndXJsJzogdXJsLCAnYWN0aW9uJzogJ2FkZFNlYXJjaCd9XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90ICd8U1BMSVRFUnwnIGluIHVybDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogc2VsZi5saXN0ICs9IFt7J25hbWUnOiAnJXMuLi4nICUgdXJsLCAndXJsJzogdXJsLCAnYWN0aW9uJzogJ2FkZFNlYXJjaCd9XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgIHNlbGYuYWRkRGlyZWN0b3J5KHNlbGYubGlzdCkKICAgICAgICAgICAgcmV0dXJuIHNlbGYubGlzdAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKCiAgICBkZWYgZGVsU2VhcmNoKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgY2FjaGUuY2xlYXIoJ3JlbF9zcmNoJykKICAgICAgICAgICAgY29udHJvbC5yZWZyZXNoKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIGFkZFNlYXJjaChzZWxmLCB1cmwpOgogICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNraXAgPSAwCiAgICAgICAgICAgICAgICBpZiAnfFNQTElURVJ8JyBpbiB1cmw6CiAgICAgICAgICAgICAgICAgICAga2VlcCA9IHVybAogICAgICAgICAgICAgICAgICAgIHVybCxtYXRjaGVyID0gdXJsLnNwbGl0KCd8U1BMSVRFUnwnKQogICAgICAgICAgICAgICAgICAgIHNraXAgPSAxCiAgICAgICAgICAgICAgICAgICAgc2VjdGlvbiA9IDEKICAgICAgICAgICAgICAgIGVsaWYgJ3xTRUNUSU9OfCcgaW4gdXJsOgogICAgICAgICAgICAgICAgICAgIG1hdGNoZXIgPSB1cmwucmVwbGFjZSgnfFNFQ1RJT058JywnJykKICAgICAgICAgICAgICAgICAgICBzZWN0aW9uID0gMQogICAgICAgICAgICAgICAgZWxzZTogCiAgICAgICAgICAgICAgICAgICAgc2VjdGlvbiA9IDAKICAgICAgICAgICAgZXhjZXB0OiBzZWN0aW9uID0gMAoKICAgICAgICAgICAgbGluayA9ICdodHRwOi8vJwoKICAgICAgICAgICAgaWYgc2tpcCA9PSAwOgogICAgICAgICAgICAgICAgaWYgc2VjdGlvbiA9PSAxOgogICAgICAgICAgICAgICAgICAgIGtleWJvYXJkID0gY29udHJvbC5rZXlib2FyZCgnJywgY29udHJvbC5sYW5nKDMwNzAyKS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgICAgICAgICAga2V5Ym9hcmQuZG9Nb2RhbCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IChrZXlib2FyZC5pc0NvbmZpcm1lZCgpKTogcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgdXJsID0ga2V5Ym9hcmQuZ2V0VGV4dCgpCiAgICAgICAgICAgICAgICAgICAga2VlcCA9IHVybCArICd8U1BMSVRFUnwnICsgbWF0Y2hlcgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBpZiAodXJsID09IE5vbmUgb3IgdXJsID09ICcnKToKICAgICAgICAgICAgICAgICAgICAgICAga2V5Ym9hcmQgPSBjb250cm9sLmtleWJvYXJkKCcnLCBjb250cm9sLmxhbmcoMzA3MDIpLmVuY29kZSgndXRmLTgnKSkKICAgICAgICAgICAgICAgICAgICAgICAga2V5Ym9hcmQuZG9Nb2RhbCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCAoa2V5Ym9hcmQuaXNDb25maXJtZWQoKSk6IHJldHVybgogICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSBrZXlib2FyZC5nZXRUZXh0KCkKCiAgICAgICAgICAgIGlmICh1cmwgPT0gTm9uZSBvciB1cmwgPT0gJycpOiByZXR1cm4KCiAgICAgICAgICAgIGlmIHNlY3Rpb24gPT0gMToKICAgICAgICAgICAgICAgIGlucHV0ID0ga2VlcAogICAgICAgICAgICBlbHNlOiAKICAgICAgICAgICAgICAgIGlucHV0ID0gdXJsCiAgICAgICAgICAgIGRlZiBzZWFyY2goKTogcmV0dXJuIFtpbnB1dF0KICAgICAgICAgICAgcXVlcnkgPSBjYWNoZS5nZXQoc2VhcmNoLCA2MDAwMDAwMDAsIHRhYmxlPSdyZWxfc3JjaCcpCgogICAgICAgICAgICBkZWYgc2VhcmNoKCk6IHJldHVybiBbeCBmb3IgeSx4IGluIGVudW1lcmF0ZSgocXVlcnkgKyBbaW5wdXRdKSkgaWYgeCBub3QgaW4gKHF1ZXJ5ICsgW2lucHV0XSlbOnldXQogICAgICAgICAgICBjYWNoZS5nZXQoc2VhcmNoLCAwLCB0YWJsZT0ncmVsX3NyY2gnKQoKICAgICAgICAgICAgbGlua3MgPSBjbGllbnQucmVxdWVzdChsaW5rKQogICAgICAgICAgICBsaW5rcyA9IHJlLmZpbmRhbGwoJzxsaW5rPiguKz8pPC9saW5rPicsIGxpbmtzKQogICAgICAgICAgICBpZiBzZWN0aW9uID09IDA6IGxpbmtzID0gW2kgZm9yIGkgaW4gbGlua3MgaWYgc3RyKGkpLnN0YXJ0c3dpdGgoJ2h0dHAnKV0KICAgICAgICAgICAgZWxzZTogbGlua3MgPSBbaSBmb3IgaSBpbiBsaW5rcyBpZiBzdHIoaSkuc3RhcnRzd2l0aCgnaHR0cCcpIGFuZCBtYXRjaGVyLmxvd2VyKCkgaW4gc3RyKGkpLmxvd2VyKCldCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxpc3QgPSBbXSA7IHRocmVhZHMgPSBbXSAKICAgICAgICAgICAgZm9yIGxpbmsgaW4gbGlua3M6IHRocmVhZHMuYXBwZW5kKHdvcmtlcnMuVGhyZWFkKHNlbGYubm9uYW1lX2xpc3QsIGxpbmspKQogICAgICAgICAgICBbaS5zdGFydCgpIGZvciBpIGluIHRocmVhZHNdIDsgW2kuam9pbigpIGZvciBpIGluIHRocmVhZHNdCgogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5saXN0ID0gW2kgZm9yIGkgaW4gc2VsZi5saXN0IGlmIHVybC5sb3dlcigpIGluIGlbJ25hbWUnXS5sb3dlcigpXQoKICAgICAgICAgICAgZm9yIGkgaW4gc2VsZi5saXN0OgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG5hbWUgPSAnJwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBpWyd2aXAnXSBpbiBbJ05vLU5hbWUgVFYnXTogbmFtZSArPSAnW0JdJXNbL0JdIHwgJyAlIGlbJ3ZpcCddLnVwcGVyKCkKICAgICAgICAgICAgICAgICAgICBuYW1lICs9IGlbJ25hbWUnXQogICAgICAgICAgICAgICAgICAgIGkudXBkYXRlKHsnbmFtZScgOiBuYW1lfSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICBmb3IgaSBpbiBzZWxmLmxpc3Q6IGkudXBkYXRlKHsnY29udGVudCc6ICd2aWRlb3MnfSkKICAgICAgICAgICAgc2VsZi5hZGREaXJlY3Rvcnkoc2VsZi5saXN0KQoKCiAgICBkZWYgbm9uYW1lX2xpc3Qoc2VsZiwgdXJsLCByZXN1bHQ9Tm9uZSk6CgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgcmVzdWx0ID09IE5vbmU6IHJlc3VsdCA9IGNhY2hlLmdldChjbGllbnQucmVxdWVzdCwgMCwgdXJsKQoKICAgICAgICAgICAgaWYgcmVzdWx0LnN0cmlwKCkuc3RhcnRzd2l0aCgnI0VYVE0zVScpIGFuZCAnI0VYVElORicgaW4gcmVzdWx0OgogICAgICAgICAgICAgICAgcmVzdWx0ID0gcmUuY29tcGlsZSgnI0VYVElORjouKz9cLCguKz8pXG4oLis/KVxuJywgcmUuTVVMVElMSU5FfHJlLkRPVEFMTCkuZmluZGFsbChyZXN1bHQpCiAgICAgICAgICAgICAgICByZXN1bHQgPSBbJzxpdGVtPjx0aXRsZT4lczwvdGl0bGU+PGxpbms+JXM8L2xpbms+PC9pdGVtPicgJSAoaVswXSwgaVsxXSkgZm9yIGkgaW4gcmVzdWx0XQogICAgICAgICAgICAgICAgcmVzdWx0ID0gJycuam9pbihyZXN1bHQpCgogICAgICAgICAgICB0cnk6IHIgPSBiYXNlNjQuYjY0ZGVjb2RlKHJlc3VsdCkKICAgICAgICAgICAgZXhjZXB0OiByID0gJycKICAgICAgICAgICAgaWYgJzwvbGluaz4nIGluIHI6IHJlc3VsdCA9IHIKCiAgICAgICAgICAgIHJlc3VsdCA9IHN0cihyZXN1bHQpCgogICAgICAgICAgICBpbmZvID0gcmVzdWx0LnNwbGl0KCc8aXRlbT4nKVswXS5zcGxpdCgnPGRpcj4nKVswXQoKICAgICAgICAgICAgdHJ5OiB2aXAgPSByZS5maW5kYWxsKCc8cG9zdGVyPiguKz8pPC9wb3N0ZXI+JywgaW5mbylbMF0KICAgICAgICAgICAgZXhjZXB0OiB2aXAgPSAnMCcKCiAgICAgICAgICAgIHRyeTogaW1hZ2UgPSByZS5maW5kYWxsKCc8dGh1bWJuYWlsPiguKz8pPC90aHVtYm5haWw+JywgaW5mbylbMF0KICAgICAgICAgICAgZXhjZXB0OiBpbWFnZSA9ICcwJwoKICAgICAgICAgICAgdHJ5OiBmYW5hcnQgPSByZS5maW5kYWxsKCc8ZmFuYXJ0PiguKz8pPC9mYW5hcnQ+JywgaW5mbylbMF0KICAgICAgICAgICAgZXhjZXB0OiBmYW5hcnQgPSAnMCcKICAgICAgICAgICAgCiAgICAgICAgICAgIGFwaV9kYXRhID0gY2xpZW50LnJlcXVlc3QoYmFzZTY0LmI2NGRlY29kZSgnYUhSMGNEb3ZMM1JsZUhSMWNHeHZZV1JsY2k1amIyMHZaSEkzTm1jdmNtRjMnKSwgdGltZW91dD0nNScpCiAgICAgICAgICAgIHRtZGJfYXBpID0gcmUuY29tcGlsZSgnPGFwaT4oLis/KTwvYXBpPicpLmZpbmRhbGwoYXBpX2RhdGEpWzBdCgogICAgICAgICAgICBpdGVtcyA9IHJlLmNvbXBpbGUoJygoPzo8aXRlbT4uKz88L2l0ZW0+fDxkaXI+Lis/PC9kaXI+fDxwbHVnaW4+Lis/PC9wbHVnaW4+fDxpbmZvPi4rPzwvaW5mbz58PG5hbWU+W148XSs8L25hbWU+PGxpbms+W148XSs8L2xpbms+PHRodW1ibmFpbD5bXjxdKzwvdGh1bWJuYWlsPjxtb2RlPltePF0rPC9tb2RlPnw8bmFtZT5bXjxdKzwvbmFtZT48bGluaz5bXjxdKzwvbGluaz48dGh1bWJuYWlsPltePF0rPC90aHVtYm5haWw+PGRhdGU+W148XSs8L2RhdGU+KSknLCByZS5NVUxUSUxJTkV8cmUuRE9UQUxMKS5maW5kYWxsKHJlc3VsdCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBmb3IgaXRlbSBpbiBpdGVtczoKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlZ2RhdGEgPSByZS5jb21waWxlKCcoPHJlZ2V4Pi4rPzwvcmVnZXg+KScsIHJlLk1VTFRJTElORXxyZS5ET1RBTEwpLmZpbmRhbGwoaXRlbSkKICAgICAgICAgICAgICAgIHJlZ2RhdGEgPSAnJy5qb2luKHJlZ2RhdGEpCiAgICAgICAgICAgICAgICByZWdsaXN0ID0gcmUuY29tcGlsZSgnKDxsaXN0cmVwZWF0Pi4rPzwvbGlzdHJlcGVhdD4pJywgcmUuTVVMVElMSU5FfHJlLkRPVEFMTCkuZmluZGFsbChyZWdkYXRhKQogICAgICAgICAgICAgICAgcmVnZGF0YSA9IHVybGxpYi5xdW90ZV9wbHVzKHJlZ2RhdGEpCgogICAgICAgICAgICAgICAgcmVnaGFzaCA9IGhhc2hsaWIubWQ1KCkKICAgICAgICAgICAgICAgIGZvciBpIGluIHJlZ2RhdGE6IHJlZ2hhc2gudXBkYXRlKHN0cihpKSkKICAgICAgICAgICAgICAgIHJlZ2hhc2ggPSBzdHIocmVnaGFzaC5oZXhkaWdlc3QoKSkKCiAgICAgICAgICAgICAgICBpdGVtID0gaXRlbS5yZXBsYWNlKCdccicsJycpLnJlcGxhY2UoJ1xuJywnJykucmVwbGFjZSgnXHQnLCcnKS5yZXBsYWNlKCcmbmJzcDsnLCcnKS5yZXBsYWNlKCc8dG1kYl9kYXRhPnRydWU8L3RtZGJfZGF0YT4nLCc8dG1kYl9kYXRhPmFsbDwvdG1kYl9kYXRhPicpCgogICAgICAgICAgICAgICAgdHJ5OiBtZXRhID0gcmUuZmluZGFsbCgnPG1ldGE+KC4rPyk8L21ldGE+JywgaXRlbSlbMF0KICAgICAgICAgICAgICAgIGV4Y2VwdDogbWV0YSA9ICcwJwoKICAgICAgICAgICAgICAgIHRyeTogaW1kYiA9IHJlLmZpbmRhbGwoJzxpbWRiPiguKz8pPC9pbWRiPicsIG1ldGEpWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IGltZGIgPSAnMCcKCiAgICAgICAgICAgICAgICB0cnk6IHRtZGJfZ2V0ID0gcmUuZmluZGFsbCgnPHRtZGJfZGF0YT4oLis/KTwvdG1kYl9kYXRhPicsIG1ldGEpWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IHRtZGJfZ2V0ID0gJzAnCgogICAgICAgICAgICAgICAgdHJ5OiB0dnNob3d0aXRsZSA9IHJlLmZpbmRhbGwoJzx0dnNob3d0aXRsZT4oLis/KTwvdHZzaG93dGl0bGU+JywgaXRlbSlbMF0KICAgICAgICAgICAgICAgIGV4Y2VwdDogdHZzaG93dGl0bGUgPSAnMCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaXRlbSA9IHJlLnN1YignPHJlZ2V4Pi4rPzwvcmVnZXg+JywnJywgaXRlbSkKICAgICAgICAgICAgICAgIGl0ZW0gPSByZS5zdWIoJzxzdWJsaW5rPjwvc3VibGluaz58PHN1YmxpbmtccytuYW1lPSg/OlwnfFwiKS4qPyg/OlwnfFwiKT48L3N1Ymxpbms+JywnJywgaXRlbSkKICAgICAgICAgICAgICAgIGl0ZW0gPSByZS5zdWIoJzxsaW5rPjwvbGluaz4nLCcnLCBpdGVtKQoKICAgICAgICAgICAgICAgIHRyeTogbWV0YSA9IHJlLmZpbmRhbGwoJzxtZXRhPiguKz8pPC9tZXRhPicsIGl0ZW0pWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IG1ldGEgPSAnMCcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgYW55KGYgZm9yIGYgaW4gWydhbGwnLCdkYXRhJywnaW1hZ2VzJ10gaWYgZiA9PSB0bWRiX2dldC5sb3dlcigpKTogICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHVybF9hcGkgPSAnaHR0cDovL2FwaS50aGVtb3ZpZWRiLm9yZy8zL21vdmllLycgKyBpbWRiICsgJz9hcGlfa2V5PScgKyB0bWRiX2FwaQogICAgICAgICAgICAgICAgICAgICAgICBpdGVtX2pzb24gPSBjbGllbnQucmVxdWVzdCh1cmxfYXBpLCB0aW1lb3V0PSc1JykKCiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1fanNvbiA9IGpzb24ubG9hZHMoaXRlbV9qc29uKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogcGFzcwoKICAgICAgICAgICAgICAgICAgICBpZiBhbnkoZiBmb3IgZiBpbiBbJ2FsbCcsJ2RhdGEnXSBpZiBmID09IHRtZGJfZ2V0Lmxvd2VyKCkpOiAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpdGVtX2pzb25bJ29yaWdpbmFsX3RpdGxlJ10gaXMgbm90IE5vbmU6IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUgPSBpdGVtX2pzb25bJ29yaWdpbmFsX3RpdGxlJ10KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSB0aXRsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZTogICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSByZS5zdWIoJzxtZXRhPi4rPzwvbWV0YT4nLCcnLCBpdGVtKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogbmFtZSA9IHJlLmZpbmRhbGwoJzx0aXRsZT4oLis/KTwvdGl0bGU+JywgbmFtZSlbMF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IG5hbWUgPSByZS5maW5kYWxsKCc8bmFtZT4oLis/KTwvbmFtZT4nLCBuYW1lKVswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogdGl0bGUgPSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiB0aXRsZSA9ICcwJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRpdGxlID09ICcwJyBhbmQgbm90IHR2c2hvd3RpdGxlID09ICcwJzogdGl0bGUgPSB0dnNob3d0aXRsZQoKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHJlLnN1YignPG1ldGE+Lis/PC9tZXRhPicsJycsIGl0ZW0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6IG5hbWUgPSByZS5maW5kYWxsKCc8dGl0bGU+KC4rPyk8L3RpdGxlPicsIG5hbWUpWzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IG5hbWUgPSByZS5maW5kYWxsKCc8bmFtZT4oLis/KTwvbmFtZT4nLCBuYW1lKVswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OiB0aXRsZSA9IG5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogdGl0bGUgPSAnMCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGl0bGUgPT0gJzAnIGFuZCBub3QgdHZzaG93dGl0bGUgPT0gJzAnOiB0aXRsZSA9IHR2c2hvd3RpdGxlCgogICAgICAgICAgICAgICAgICAgICAgICBpZiAnPHRpdGxlPjwvdGl0bGU+JyBpbiBpdGVtOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IGl0ZW0ucmVwbGFjZSgnPHRpdGxlPjwvdGl0bGU+JywnPHRpdGxlPicrdGl0bGUrJzwvdGl0bGU+JykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGl0ZW1fanNvblsncmVsZWFzZV9kYXRlJ10gaXMgbm90IE5vbmU6IHllYXIgPSBpdGVtX2pzb25bJ3JlbGVhc2VfZGF0ZSddOyB5ZWFyID0geWVhci5zcGxpdCgnLScpWzBdOyBuYW1lID0gdGl0bGUgKyAnICgnICsgeWVhciArICcpJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZTogCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OiB5ZWFyID0gcmUuZmluZGFsbCgnPHllYXI+KC4rPyk8L3llYXI+JywgbWV0YSlbMF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IHllYXIgPSAnMCcKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OiB5ZWFyID0gcmUuZmluZGFsbCgnPHllYXI+KC4rPyk8L3llYXI+JywgbWV0YSlbMF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogeWVhciA9ICcwJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICc8eWVhcj48L3llYXI+JyBpbiBpdGVtOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IGl0ZW0ucmVwbGFjZSgnPHllYXI+PC95ZWFyPicsJzx5ZWFyPicrdGl0bGUrJzwveWVhcj4nKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSByZS5zdWIoJzxtZXRhPi4rPzwvbWV0YT4nLCcnLCBpdGVtKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IG5hbWUgPSByZS5maW5kYWxsKCc8dGl0bGU+KC4rPyk8L3RpdGxlPicsIG5hbWUpWzBdCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogbmFtZSA9IHJlLmZpbmRhbGwoJzxuYW1lPiguKz8pPC9uYW1lPicsIG5hbWUpWzBdCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogdGl0bGUgPSBuYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogdGl0bGUgPSAnMCcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgJzx0aXRsZT48L3RpdGxlPicgaW4gaXRlbToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSBpdGVtLnJlcGxhY2UoJzx0aXRsZT48L3RpdGxlPicsJzx0aXRsZT4nK3RpdGxlKyc8L3RpdGxlPicpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogeWVhciA9IHJlLmZpbmRhbGwoJzx5ZWFyPiguKz8pPC95ZWFyPicsIG1ldGEpWzBdCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogeWVhciA9ICcwJwogICAgICAgICAgICAgICAgICAgICAgICBpZiAnPHllYXI+PC95ZWFyPicgaW4gaXRlbToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSBpdGVtLnJlcGxhY2UoJzx5ZWFyPjwveWVhcj4nLCc8eWVhcj4nK3RpdGxlKyc8L3llYXI+JykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBhbnkoZiBmb3IgZiBpbiBbJ2FsbCcsJ2ltYWdlcyddIGlmIGYgPT0gdG1kYl9nZXQubG93ZXIoKSk6ICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpdGVtX2pzb25bJ2JhY2tkcm9wX3BhdGgnXSBpcyBub3QgTm9uZTogZmFuYXJ0MiA9ICdodHRwOi8vaW1hZ2UudG1kYi5vcmcvdC9wL29yaWdpbmFsLycgKyBpdGVtX2pzb25bJ2JhY2tkcm9wX3BhdGgnXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZTogCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OiBmYW5hcnQyID0gcmUuZmluZGFsbCgnPGZhbmFydD4oLis/KTwvZmFuYXJ0PicsIGl0ZW0pWzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBmYW5hcnQyID0gZmFuYXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogZmFuYXJ0MiA9IHJlLmZpbmRhbGwoJzxmYW5hcnQ+KC4rPyk8L2ZhbmFydD4nLCBpdGVtKVswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBmYW5hcnQyID0gZmFuYXJ0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXRlbV9qc29uWydwb3N0ZXJfcGF0aCddIGlzIG5vdCBOb25lOiBpbWFnZTIgPSAnaHR0cDovL2ltYWdlLnRtZGIub3JnL3QvcC9vcmlnaW5hbC8nICsgaXRlbV9qc29uWydwb3N0ZXJfcGF0aCddCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOiAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6IGltYWdlMiA9IHJlLmZpbmRhbGwoJzx0aHVtYm5haWw+KC4rPyk8L3RodW1ibmFpbD4nLCBpdGVtKVswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogaW1hZ2UyID0gaW1hZ2UKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OiBpbWFnZTIgPSByZS5maW5kYWxsKCc8dGh1bWJuYWlsPiguKz8pPC90aHVtYm5haWw+JywgaXRlbSlbMF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogaW1hZ2UyID0gaW1hZ2UKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IGZhbmFydDIgPSByZS5maW5kYWxsKCc8ZmFuYXJ0PiguKz8pPC9mYW5hcnQ+JywgaXRlbSlbMF0KICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBmYW5hcnQyID0gZmFuYXJ0CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogaW1hZ2UyID0gcmUuZmluZGFsbCgnPHRodW1ibmFpbD4oLis/KTwvdGh1bWJuYWlsPicsIGl0ZW0pWzBdCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogaW1hZ2UyID0gaW1hZ2UKICAgICAgICAgICAgICAgIGVsc2U6CgogICAgICAgICAgICAgICAgICAgIG5hbWUgPSByZS5zdWIoJzxtZXRhPi4rPzwvbWV0YT4nLCcnLCBpdGVtKQogICAgICAgICAgICAgICAgICAgIHRyeTogbmFtZSA9IHJlLmZpbmRhbGwoJzx0aXRsZT4oLis/KTwvdGl0bGU+JywgbmFtZSlbMF0KICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IG5hbWUgPSByZS5maW5kYWxsKCc8bmFtZT4oLis/KTwvbmFtZT4nLCBuYW1lKVswXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRyeTogdGl0bGUgPSByZS5maW5kYWxsKCc8dGl0bGU+KC4rPyk8L3RpdGxlPicsIG1ldGEpWzBdCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiB0aXRsZSA9ICcwJwoKICAgICAgICAgICAgICAgICAgICBpZiB0aXRsZSA9PSAnMCcgYW5kIG5vdCB0dnNob3d0aXRsZSA9PSAnMCc6IHRpdGxlID0gdHZzaG93dGl0bGUKCiAgICAgICAgICAgICAgICAgICAgdHJ5OiB5ZWFyID0gcmUuZmluZGFsbCgnPHllYXI+KC4rPyk8L3llYXI+JywgbWV0YSlbMF0KICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IHllYXIgPSAnMCcKCiAgICAgICAgICAgICAgICAgICAgdHJ5OiBpbWFnZTIgPSByZS5maW5kYWxsKCc8dGh1bWJuYWlsPiguKz8pPC90aHVtYm5haWw+JywgaXRlbSlbMF0KICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IGltYWdlMiA9IGltYWdlCgogICAgICAgICAgICAgICAgICAgIHRyeTogZmFuYXJ0MiA9IHJlLmZpbmRhbGwoJzxmYW5hcnQ+KC4rPyk8L2ZhbmFydD4nLCBpdGVtKVswXQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogZmFuYXJ0MiA9IGZhbmFydAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeTogZGF0ZSA9IHJlLmZpbmRhbGwoJzxkYXRlPiguKz8pPC9kYXRlPicsIGl0ZW0pWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IGRhdGUgPSAnJwogICAgICAgICAgICAgICAgaWYgcmUuc2VhcmNoKHInXGQrJywgZGF0ZSk6IG5hbWUgKz0gJyBbQ09MT1IgcmVkXSBVcGRhdGVkICVzWy9DT0xPUl0nICUgZGF0ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0cnk6IG1ldGEgPSByZS5maW5kYWxsKCc8bWV0YT4oLis/KTwvbWV0YT4nLCBpdGVtKVswXQogICAgICAgICAgICAgICAgZXhjZXB0OiBtZXRhID0gJzAnCiAgICAgICAgICAgICAgICB0cnk6IHVybCA9IHJlLmZpbmRhbGwoJzxsaW5rPiguKz8pPC9saW5rPicsIGl0ZW0pWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IHVybCA9ICcwJwogICAgICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoJz5zZWFyY2g8JywgJz48cHJlc2V0PnNlYXJjaDwvcHJlc2V0PiVzPCcgJSBtZXRhKQogICAgICAgICAgICAgICAgdXJsID0gJzxwcmVzZXQ+c2VhcmNoPC9wcmVzZXQ+JXMnICUgbWV0YSBpZiB1cmwgPT0gJ3NlYXJjaCcgZWxzZSB1cmwKICAgICAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKCc+c2VhcmNoc2Q8JywgJz48cHJlc2V0PnNlYXJjaHNkPC9wcmVzZXQ+JXM8JyAlIG1ldGEpCiAgICAgICAgICAgICAgICB1cmwgPSAnPHByZXNldD5zZWFyY2hzZDwvcHJlc2V0PiVzJyAlIG1ldGEgaWYgdXJsID09ICdzZWFyY2hzZCcgZWxzZSB1cmwKICAgICAgICAgICAgICAgIHVybCA9IHJlLnN1YignPHN1Ymxpbms+PC9zdWJsaW5rPnw8c3VibGlua1xzK25hbWU9KD86XCd8XCIpLio/KD86XCd8XCIpPjwvc3VibGluaz4nLCcnLCB1cmwpCgogICAgICAgICAgICAgICAgaWYgaXRlbS5zdGFydHN3aXRoKCc8aXRlbT4nKTogYWN0aW9uID0gJ3BsYXknCiAgICAgICAgICAgICAgICBlbGlmIGl0ZW0uc3RhcnRzd2l0aCgnPHBsdWdpbj4nKTogYWN0aW9uID0gJ3BsdWdpbicKICAgICAgICAgICAgICAgIGVsaWYgaXRlbS5zdGFydHN3aXRoKCc8aW5mbz4nKSBvciB1cmwgPT0gJzAnOiBhY3Rpb24gPSAnMCcKICAgICAgICAgICAgICAgIGVsc2U6IGFjdGlvbiA9ICdkaXJlY3RvcnknCiAgICAgICAgICAgICAgICBpZiBhY3Rpb24gPT0gJ3BsYXknIGFuZCByZWdsaXN0OiBhY3Rpb24gPSAneGRpcmVjdG9yeScKCiAgICAgICAgICAgICAgICBpZiBub3QgcmVnZGF0YSA9PSAnJzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmhhc2guYXBwZW5kKHsncmVnZXgnOiByZWdoYXNoLCAncmVzcG9uc2UnOiByZWdkYXRhfSkKICAgICAgICAgICAgICAgICAgICB1cmwgKz0gJ3xyZWdleD0lcycgJSByZWdoYXNoCgogICAgICAgICAgICAgICAgaWYgYWN0aW9uIGluIFsnZGlyZWN0b3J5JywgJ3hkaXJlY3RvcnknLCAncGx1Z2luJ106CiAgICAgICAgICAgICAgICAgICAgZm9sZGVyID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBmb2xkZXIgPSBGYWxzZQoKICAgICAgICAgICAgICAgIHRyeTogY29udGVudCA9IHJlLmZpbmRhbGwoJzxjb250ZW50PiguKz8pPC9jb250ZW50PicsIG1ldGEpWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IGNvbnRlbnQgPSAnMCcKICAgICAgICAgICAgICAgIGlmIGNvbnRlbnQgPT0gJzAnOiAKICAgICAgICAgICAgICAgICAgICB0cnk6IGNvbnRlbnQgPSByZS5maW5kYWxsKCc8Y29udGVudD4oLis/KTwvY29udGVudD4nLCBpdGVtKVswXQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogY29udGVudCA9ICcwJwogICAgICAgICAgICAgICAgaWYgbm90IGNvbnRlbnQgPT0gJzAnOiBjb250ZW50ICs9ICdzJwoKICAgICAgICAgICAgICAgIGlmICd0dnNob3cnIGluIGNvbnRlbnQgYW5kIG5vdCB1cmwuc3RyaXAoKS5lbmRzd2l0aCgnLnhtbCcpOgogICAgICAgICAgICAgICAgICAgIHVybCA9ICc8cHJlc2V0PnR2aW5kZXhlcjwvcHJlc2V0Pjx1cmw+JXM8L3VybD48dGh1bWJuYWlsPiVzPC90aHVtYm5haWw+PGZhbmFydD4lczwvZmFuYXJ0PiVzJyAlICh1cmwsIGltYWdlMiwgZmFuYXJ0MiwgbWV0YSkKICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAndHZ0dW5lcicKCiAgICAgICAgICAgICAgICBpZiAndHZ0dW5lcicgaW4gY29udGVudCBhbmQgbm90IHVybC5zdHJpcCgpLmVuZHN3aXRoKCcueG1sJyk6CiAgICAgICAgICAgICAgICAgICAgdXJsID0gJzxwcmVzZXQ+dHZ0dW5lcjwvcHJlc2V0Pjx1cmw+JXM8L3VybD48dGh1bWJuYWlsPiVzPC90aHVtYm5haWw+PGZhbmFydD4lczwvZmFuYXJ0PiVzJyAlICh1cmwsIGltYWdlMiwgZmFuYXJ0MiwgbWV0YSkKICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAndHZ0dW5lcicKCiAgICAgICAgICAgICAgICB0cnk6IHR2ZGIgPSByZS5maW5kYWxsKCc8dHZkYj4oLis/KTwvdHZkYj4nLCBtZXRhKVswXQogICAgICAgICAgICAgICAgZXhjZXB0OiB0dmRiID0gJzAnCgogICAgICAgICAgICAgICAgdHJ5OiBwcmVtaWVyZWQgPSByZS5maW5kYWxsKCc8cHJlbWllcmVkPiguKz8pPC9wcmVtaWVyZWQ+JywgbWV0YSlbMF0KICAgICAgICAgICAgICAgIGV4Y2VwdDogcHJlbWllcmVkID0gJzAnCgogICAgICAgICAgICAgICAgdHJ5OiBzZWFzb24gPSByZS5maW5kYWxsKCc8c2Vhc29uPiguKz8pPC9zZWFzb24+JywgbWV0YSlbMF0KICAgICAgICAgICAgICAgIGV4Y2VwdDogc2Vhc29uID0gJzAnCgogICAgICAgICAgICAgICAgdHJ5OiBlcGlzb2RlID0gcmUuZmluZGFsbCgnPGVwaXNvZGU+KC4rPyk8L2VwaXNvZGU+JywgbWV0YSlbMF0KICAgICAgICAgICAgICAgIGV4Y2VwdDogZXBpc29kZSA9ICcwJwoKICAgICAgICAgICAgICAgIHNlbGYubGlzdC5hcHBlbmQoeyduYW1lJzogbmFtZSwgJ3ZpcCc6IHZpcCwgJ3VybCc6IHVybCwgJ2FjdGlvbic6IGFjdGlvbiwgJ2ZvbGRlcic6IGZvbGRlciwgJ3Bvc3Rlcic6IGltYWdlMiwgJ2Jhbm5lcic6ICcwJywgJ2ZhbmFydCc6IGZhbmFydDIsICdjb250ZW50JzogY29udGVudCwgJ2ltZGInOiBpbWRiLCAndHZkYic6IHR2ZGIsICd0bWRiJzogJzAnLCAndGl0bGUnOiB0aXRsZSwgJ29yaWdpbmFsdGl0bGUnOiB0aXRsZSwgJ3R2c2hvd3RpdGxlJzogdHZzaG93dGl0bGUsICd5ZWFyJzogeWVhciwgJ3ByZW1pZXJlZCc6IHByZW1pZXJlZCwgJ3NlYXNvbic6IHNlYXNvbiwgJ2VwaXNvZGUnOiBlcGlzb2RlfSkKCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MgICAgICAgICAgICAKCiAgICAgICAgcmVnZXguaW5zZXJ0KHNlbGYuaGFzaCkKCiAgICAgICAgcmV0dXJuIHNlbGYubGlzdAoKICAgIGRlZiB3b3JrZXIoc2VsZik6CiAgICAgICAgaWYgbm90IGNvbnRyb2wuc2V0dGluZygnbWV0YWRhdGEnKSA9PSAndHJ1ZSc6IHJldHVybgoKICAgICAgICBzZWxmLmltZGJfaW5mb19saW5rID0gJ2h0dHA6Ly93d3cub21kYmFwaS5jb20vP2k9JXMmcGxvdD1mdWxsJnI9anNvbicKICAgICAgICBzZWxmLnR2bWF6ZV9pbmZvX2xpbmsgPSAnaHR0cDovL2FwaS50dm1hemUuY29tL2xvb2t1cC9zaG93cz90aGV0dmRiPSVzJwogICAgICAgIHNlbGYubGFuZyA9ICdlbicKCiAgICAgICAgc2VsZi5tZXRhID0gW10KICAgICAgICB0b3RhbCA9IGxlbihzZWxmLmxpc3QpCiAgICAgICAgaWYgdG90YWwgPT0gMDogcmV0dXJuCgogICAgICAgIGZvciBpIGluIHJhbmdlKDAsIHRvdGFsKTogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J21ldGFjYWNoZSc6IEZhbHNlfSkKICAgICAgICBzZWxmLmxpc3QgPSBtZXRhY2FjaGUuZmV0Y2goc2VsZi5saXN0LCBzZWxmLmxhbmcpCgogICAgICAgIG11bHRpID0gW2lbJ2ltZGInXSBmb3IgaSBpbiBzZWxmLmxpc3RdCiAgICAgICAgbXVsdGkgPSBbeCBmb3IgeSx4IGluIGVudW1lcmF0ZShtdWx0aSkgaWYgeCBub3QgaW4gbXVsdGlbOnldXQogICAgICAgIGlmIGxlbihtdWx0aSkgPT0gMToKICAgICAgICAgICAgICAgIHNlbGYubW92aWVfaW5mbygwKSA7IHNlbGYudHZfaW5mbygwKQogICAgICAgICAgICAgICAgaWYgc2VsZi5tZXRhOiBtZXRhY2FjaGUuaW5zZXJ0KHNlbGYubWV0YSkKCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMCwgdG90YWwpOiBzZWxmLmxpc3RbaV0udXBkYXRlKHsnbWV0YWNhY2hlJzogRmFsc2V9KQogICAgICAgIHNlbGYubGlzdCA9IG1ldGFjYWNoZS5mZXRjaChzZWxmLmxpc3QsIHNlbGYubGFuZykKCiAgICAgICAgZm9yIHIgaW4gcmFuZ2UoMCwgdG90YWwsIDUwKToKICAgICAgICAgICAgdGhyZWFkcyA9IFtdCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKHIsIHIrNTApOgogICAgICAgICAgICAgICAgaWYgaSA8PSB0b3RhbDogdGhyZWFkcy5hcHBlbmQod29ya2Vycy5UaHJlYWQoc2VsZi5tb3ZpZV9pbmZvLCBpKSkKICAgICAgICAgICAgICAgIGlmIGkgPD0gdG90YWw6IHRocmVhZHMuYXBwZW5kKHdvcmtlcnMuVGhyZWFkKHNlbGYudHZfaW5mbywgaSkpCiAgICAgICAgICAgIFtpLnN0YXJ0KCkgZm9yIGkgaW4gdGhyZWFkc10KICAgICAgICAgICAgW2kuam9pbigpIGZvciBpIGluIHRocmVhZHNdCgogICAgICAgIGlmIHNlbGYubWV0YTogbWV0YWNhY2hlLmluc2VydChzZWxmLm1ldGEpCgoKICAgIGRlZiBtb3ZpZV9pbmZvKHNlbGYsIGkpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5saXN0W2ldWydtZXRhY2FjaGUnXSA9PSBUcnVlOiByYWlzZSBFeGNlcHRpb24oKQoKICAgICAgICAgICAgaWYgbm90IHNlbGYubGlzdFtpXVsnY29udGVudCddID09ICdtb3ZpZXMnOiByYWlzZSBFeGNlcHRpb24oKQoKICAgICAgICAgICAgaW1kYiA9IHNlbGYubGlzdFtpXVsnaW1kYiddCiAgICAgICAgICAgIGlmIGltZGIgPT0gJzAnOiByYWlzZSBFeGNlcHRpb24oKQoKICAgICAgICAgICAgdXJsID0gc2VsZi5pbWRiX2luZm9fbGluayAlIGltZGIKCiAgICAgICAgICAgIGl0ZW0gPSBjbGllbnQucmVxdWVzdCh1cmwsIHRpbWVvdXQ9JzEwJykKICAgICAgICAgICAgaXRlbSA9IGpzb24ubG9hZHMoaXRlbSkKCiAgICAgICAgICAgIGlmICdFcnJvcicgaW4gaXRlbSBhbmQgJ2luY29ycmVjdCBpbWRiJyBpbiBpdGVtWydFcnJvciddLmxvd2VyKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5tZXRhLmFwcGVuZCh7J2ltZGInOiBpbWRiLCAndG1kYic6ICcwJywgJ3R2ZGInOiAnMCcsICdsYW5nJzogc2VsZi5sYW5nLCAnaXRlbSc6IHsnY29kZSc6ICcwJ319KQoKICAgICAgICAgICAgdGl0bGUgPSBpdGVtWydUaXRsZSddCiAgICAgICAgICAgIHRpdGxlID0gdGl0bGUuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCB0aXRsZSA9PSAnMCc6IHNlbGYubGlzdFtpXS51cGRhdGUoeyd0aXRsZSc6IHRpdGxlfSkKCiAgICAgICAgICAgIHllYXIgPSBpdGVtWydZZWFyJ10KICAgICAgICAgICAgeWVhciA9IHllYXIuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCB5ZWFyID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J3llYXInOiB5ZWFyfSkKCiAgICAgICAgICAgIGltZGIgPSBpdGVtWydpbWRiSUQnXQogICAgICAgICAgICBpZiBpbWRiID09IE5vbmUgb3IgaW1kYiA9PSAnJyBvciBpbWRiID09ICdOL0EnOiBpbWRiID0gJzAnCiAgICAgICAgICAgIGltZGIgPSBpbWRiLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3QgaW1kYiA9PSAnMCc6IHNlbGYubGlzdFtpXS51cGRhdGUoeydpbWRiJzogaW1kYiwgJ2NvZGUnOiBpbWRifSkKCiAgICAgICAgICAgIHByZW1pZXJlZCA9IGl0ZW1bJ1JlbGVhc2VkJ10KICAgICAgICAgICAgaWYgcHJlbWllcmVkID09IE5vbmUgb3IgcHJlbWllcmVkID09ICcnIG9yIHByZW1pZXJlZCA9PSAnTi9BJzogcHJlbWllcmVkID0gJzAnCiAgICAgICAgICAgIHByZW1pZXJlZCA9IHJlLmZpbmRhbGwoJyhcZCopICguKz8pIChcZCopJywgcHJlbWllcmVkKQogICAgICAgICAgICB0cnk6IHByZW1pZXJlZCA9ICclcy0lcy0lcycgJSAocHJlbWllcmVkWzBdWzJdLCB7J0phbic6JzAxJywgJ0ZlYic6JzAyJywgJ01hcic6JzAzJywgJ0Fwcic6JzA0JywgJ01heSc6JzA1JywgJ0p1bic6JzA2JywgJ0p1bCc6JzA3JywgJ0F1Zyc6JzA4JywgJ1NlcCc6JzA5JywgJ09jdCc6JzEwJywgJ05vdic6JzExJywgJ0RlYyc6JzEyJ31bcHJlbWllcmVkWzBdWzFdXSwgcHJlbWllcmVkWzBdWzBdKQogICAgICAgICAgICBleGNlcHQ6IHByZW1pZXJlZCA9ICcwJwogICAgICAgICAgICBwcmVtaWVyZWQgPSBwcmVtaWVyZWQuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCBwcmVtaWVyZWQgPT0gJzAnOiBzZWxmLmxpc3RbaV0udXBkYXRlKHsncHJlbWllcmVkJzogcHJlbWllcmVkfSkKCiAgICAgICAgICAgIGdlbnJlID0gaXRlbVsnR2VucmUnXQogICAgICAgICAgICBpZiBnZW5yZSA9PSBOb25lIG9yIGdlbnJlID09ICcnIG9yIGdlbnJlID09ICdOL0EnOiBnZW5yZSA9ICcwJwogICAgICAgICAgICBnZW5yZSA9IGdlbnJlLnJlcGxhY2UoJywgJywgJyAvICcpCiAgICAgICAgICAgIGdlbnJlID0gZ2VucmUuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCBnZW5yZSA9PSAnMCc6IHNlbGYubGlzdFtpXS51cGRhdGUoeydnZW5yZSc6IGdlbnJlfSkKCiAgICAgICAgICAgIGR1cmF0aW9uID0gaXRlbVsnUnVudGltZSddCiAgICAgICAgICAgIGlmIGR1cmF0aW9uID09IE5vbmUgb3IgZHVyYXRpb24gPT0gJycgb3IgZHVyYXRpb24gPT0gJ04vQSc6IGR1cmF0aW9uID0gJzAnCiAgICAgICAgICAgIGR1cmF0aW9uID0gcmUuc3ViKCdbXjAtOV0nLCAnJywgc3RyKGR1cmF0aW9uKSkKICAgICAgICAgICAgdHJ5OiBkdXJhdGlvbiA9IHN0cihpbnQoZHVyYXRpb24pICogNjApCiAgICAgICAgICAgIGV4Y2VwdDogcGFzcwogICAgICAgICAgICBkdXJhdGlvbiA9IGR1cmF0aW9uLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3QgZHVyYXRpb24gPT0gJzAnOiBzZWxmLmxpc3RbaV0udXBkYXRlKHsnZHVyYXRpb24nOiBkdXJhdGlvbn0pCgogICAgICAgICAgICByYXRpbmcgPSBpdGVtWydpbWRiUmF0aW5nJ10KICAgICAgICAgICAgaWYgcmF0aW5nID09IE5vbmUgb3IgcmF0aW5nID09ICcnIG9yIHJhdGluZyA9PSAnTi9BJyBvciByYXRpbmcgPT0gJzAuMCc6IHJhdGluZyA9ICcwJwogICAgICAgICAgICByYXRpbmcgPSByYXRpbmcuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCByYXRpbmcgPT0gJzAnOiBzZWxmLmxpc3RbaV0udXBkYXRlKHsncmF0aW5nJzogcmF0aW5nfSkKCiAgICAgICAgICAgIHZvdGVzID0gaXRlbVsnaW1kYlZvdGVzJ10KICAgICAgICAgICAgdHJ5OiB2b3RlcyA9IHN0cihmb3JtYXQoaW50KHZvdGVzKSwnLGQnKSkKICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIGlmIHZvdGVzID09IE5vbmUgb3Igdm90ZXMgPT0gJycgb3Igdm90ZXMgPT0gJ04vQSc6IHZvdGVzID0gJzAnCiAgICAgICAgICAgIHZvdGVzID0gdm90ZXMuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCB2b3RlcyA9PSAnMCc6IHNlbGYubGlzdFtpXS51cGRhdGUoeyd2b3Rlcyc6IHZvdGVzfSkKCiAgICAgICAgICAgIG1wYWEgPSBpdGVtWydSYXRlZCddCiAgICAgICAgICAgIGlmIG1wYWEgPT0gTm9uZSBvciBtcGFhID09ICcnIG9yIG1wYWEgPT0gJ04vQSc6IG1wYWEgPSAnMCcKICAgICAgICAgICAgbXBhYSA9IG1wYWEuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCBtcGFhID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J21wYWEnOiBtcGFhfSkKCiAgICAgICAgICAgIGRpcmVjdG9yID0gaXRlbVsnRGlyZWN0b3InXQogICAgICAgICAgICBpZiBkaXJlY3RvciA9PSBOb25lIG9yIGRpcmVjdG9yID09ICcnIG9yIGRpcmVjdG9yID09ICdOL0EnOiBkaXJlY3RvciA9ICcwJwogICAgICAgICAgICBkaXJlY3RvciA9IGRpcmVjdG9yLnJlcGxhY2UoJywgJywgJyAvICcpCiAgICAgICAgICAgIGRpcmVjdG9yID0gcmUuc3ViKHInXCguKj9cKScsICcnLCBkaXJlY3RvcikKICAgICAgICAgICAgZGlyZWN0b3IgPSAnICcuam9pbihkaXJlY3Rvci5zcGxpdCgpKQogICAgICAgICAgICBkaXJlY3RvciA9IGRpcmVjdG9yLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3QgZGlyZWN0b3IgPT0gJzAnOiBzZWxmLmxpc3RbaV0udXBkYXRlKHsnZGlyZWN0b3InOiBkaXJlY3Rvcn0pCgogICAgICAgICAgICB3cml0ZXIgPSBpdGVtWydXcml0ZXInXQogICAgICAgICAgICBpZiB3cml0ZXIgPT0gTm9uZSBvciB3cml0ZXIgPT0gJycgb3Igd3JpdGVyID09ICdOL0EnOiB3cml0ZXIgPSAnMCcKICAgICAgICAgICAgd3JpdGVyID0gd3JpdGVyLnJlcGxhY2UoJywgJywgJyAvICcpCiAgICAgICAgICAgIHdyaXRlciA9IHJlLnN1YihyJ1woLio/XCknLCAnJywgd3JpdGVyKQogICAgICAgICAgICB3cml0ZXIgPSAnICcuam9pbih3cml0ZXIuc3BsaXQoKSkKICAgICAgICAgICAgd3JpdGVyID0gd3JpdGVyLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3Qgd3JpdGVyID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J3dyaXRlcic6IHdyaXRlcn0pCgogICAgICAgICAgICBjYXN0ID0gaXRlbVsnQWN0b3JzJ10KICAgICAgICAgICAgaWYgY2FzdCA9PSBOb25lIG9yIGNhc3QgPT0gJycgb3IgY2FzdCA9PSAnTi9BJzogY2FzdCA9ICcwJwogICAgICAgICAgICBjYXN0ID0gW3guc3RyaXAoKSBmb3IgeCBpbiBjYXN0LnNwbGl0KCcsJykgaWYgbm90IHggPT0gJyddCiAgICAgICAgICAgIHRyeTogY2FzdCA9IFsoeC5lbmNvZGUoJ3V0Zi04JyksICcnKSBmb3IgeCBpbiBjYXN0XQogICAgICAgICAgICBleGNlcHQ6IGNhc3QgPSBbXQogICAgICAgICAgICBpZiBjYXN0ID09IFtdOiBjYXN0ID0gJzAnCiAgICAgICAgICAgIGlmIG5vdCBjYXN0ID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J2Nhc3QnOiBjYXN0fSkKCiAgICAgICAgICAgIHBsb3QgPSBpdGVtWydQbG90J10KICAgICAgICAgICAgaWYgcGxvdCA9PSBOb25lIG9yIHBsb3QgPT0gJycgb3IgcGxvdCA9PSAnTi9BJzogcGxvdCA9ICcwJwogICAgICAgICAgICBwbG90ID0gY2xpZW50LnJlcGxhY2VIVE1MQ29kZXMocGxvdCkKICAgICAgICAgICAgcGxvdCA9IHBsb3QuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCBwbG90ID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J3Bsb3QnOiBwbG90fSkKCiAgICAgICAgICAgIHNlbGYubWV0YS5hcHBlbmQoeydpbWRiJzogaW1kYiwgJ3RtZGInOiAnMCcsICd0dmRiJzogJzAnLCAnbGFuZyc6IHNlbGYubGFuZywgJ2l0ZW0nOiB7J3RpdGxlJzogdGl0bGUsICd5ZWFyJzogeWVhciwgJ2NvZGUnOiBpbWRiLCAnaW1kYic6IGltZGIsICdwcmVtaWVyZWQnOiBwcmVtaWVyZWQsICdnZW5yZSc6IGdlbnJlLCAnZHVyYXRpb24nOiBkdXJhdGlvbiwgJ3JhdGluZyc6IHJhdGluZywgJ3ZvdGVzJzogdm90ZXMsICdtcGFhJzogbXBhYSwgJ2RpcmVjdG9yJzogZGlyZWN0b3IsICd3cml0ZXInOiB3cml0ZXIsICdjYXN0JzogY2FzdCwgJ3Bsb3QnOiBwbG90fX0pCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgoKICAgIGRlZiB0dl9pbmZvKHNlbGYsIGkpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5saXN0W2ldWydtZXRhY2FjaGUnXSA9PSBUcnVlOiByYWlzZSBFeGNlcHRpb24oKQoKICAgICAgICAgICAgaWYgbm90IHNlbGYubGlzdFtpXVsnY29udGVudCddIGluIFsndHZzaG93cycsICdzZWFzb25zJywgJ2VwaXNvZGVzJ106IHJhaXNlIEV4Y2VwdGlvbigpCgogICAgICAgICAgICB0dmRiID0gc2VsZi5saXN0W2ldWyd0dmRiJ10KICAgICAgICAgICAgaWYgdHZkYiA9PSAnMCc6IHJhaXNlIEV4Y2VwdGlvbigpCgogICAgICAgICAgICB1cmwgPSBzZWxmLnR2bWF6ZV9pbmZvX2xpbmsgJSB0dmRiCgogICAgICAgICAgICBpdGVtID0gY2xpZW50LnJlcXVlc3QodXJsLCBvdXRwdXQ9J2V4dGVuZGVkJywgZXJyb3I9VHJ1ZSwgdGltZW91dD0nMTAnKQoKICAgICAgICAgICAgaWYgaXRlbVsxXSA9PSAnNDA0JzoKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLm1ldGEuYXBwZW5kKHsnaW1kYic6ICcwJywgJ3RtZGInOiAnMCcsICd0dmRiJzogdHZkYiwgJ2xhbmcnOiBzZWxmLmxhbmcsICdpdGVtJzogeydjb2RlJzogJzAnfX0pCgogICAgICAgICAgICBpdGVtID0ganNvbi5sb2FkcyhpdGVtWzBdKQoKICAgICAgICAgICAgdHZzaG93dGl0bGUgPSBpdGVtWyduYW1lJ10KICAgICAgICAgICAgdHZzaG93dGl0bGUgPSB0dnNob3d0aXRsZS5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgaWYgbm90IHR2c2hvd3RpdGxlID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J3R2c2hvd3RpdGxlJzogdHZzaG93dGl0bGV9KQoKICAgICAgICAgICAgeWVhciA9IGl0ZW1bJ3ByZW1pZXJlZCddCiAgICAgICAgICAgIHllYXIgPSByZS5maW5kYWxsKCcoXGR7NH0pJywgeWVhcilbMF0KICAgICAgICAgICAgeWVhciA9IHllYXIuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgIGlmIG5vdCB5ZWFyID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J3llYXInOiB5ZWFyfSkKCiAgICAgICAgICAgIHRyeTogaW1kYiA9IGl0ZW1bJ2V4dGVybmFscyddWydpbWRiJ10KICAgICAgICAgICAgZXhjZXB0OiBpbWRiID0gJzAnCiAgICAgICAgICAgIGlmIGltZGIgPT0gJycgb3IgaW1kYiA9PSBOb25lOiBpbWRiID0gJzAnCiAgICAgICAgICAgIGltZGIgPSBpbWRiLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBzZWxmLmxpc3RbaV1bJ2ltZGInXSA9PSAnMCcgYW5kIG5vdCBpbWRiID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J2ltZGInOiBpbWRifSkKCiAgICAgICAgICAgIHRyeTogc3R1ZGlvID0gaXRlbVsnbmV0d29yayddWyduYW1lJ10KICAgICAgICAgICAgZXhjZXB0OiBzdHVkaW8gPSAnMCcKICAgICAgICAgICAgaWYgc3R1ZGlvID09ICcnIG9yIHN0dWRpbyA9PSBOb25lOiBzdHVkaW8gPSAnMCcKICAgICAgICAgICAgc3R1ZGlvID0gc3R1ZGlvLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3Qgc3R1ZGlvID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J3N0dWRpbyc6IHN0dWRpb30pCgogICAgICAgICAgICBnZW5yZSA9IGl0ZW1bJ2dlbnJlcyddCiAgICAgICAgICAgIGlmIGdlbnJlID09ICcnIG9yIGdlbnJlID09IE5vbmUgb3IgZ2VucmUgPT0gW106IGdlbnJlID0gJzAnCiAgICAgICAgICAgIGdlbnJlID0gJyAvICcuam9pbihnZW5yZSkKICAgICAgICAgICAgZ2VucmUgPSBnZW5yZS5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgaWYgbm90IGdlbnJlID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J2dlbnJlJzogZ2VucmV9KQoKICAgICAgICAgICAgdHJ5OiBkdXJhdGlvbiA9IHN0cihpdGVtWydydW50aW1lJ10pCiAgICAgICAgICAgIGV4Y2VwdDogZHVyYXRpb24gPSAnMCcKICAgICAgICAgICAgaWYgZHVyYXRpb24gPT0gJycgb3IgZHVyYXRpb24gPT0gTm9uZTogZHVyYXRpb24gPSAnMCcKICAgICAgICAgICAgdHJ5OiBkdXJhdGlvbiA9IHN0cihpbnQoZHVyYXRpb24pICogNjApCiAgICAgICAgICAgIGV4Y2VwdDogcGFzcwogICAgICAgICAgICBkdXJhdGlvbiA9IGR1cmF0aW9uLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3QgZHVyYXRpb24gPT0gJzAnOiBzZWxmLmxpc3RbaV0udXBkYXRlKHsnZHVyYXRpb24nOiBkdXJhdGlvbn0pCgogICAgICAgICAgICByYXRpbmcgPSBzdHIoaXRlbVsncmF0aW5nJ11bJ2F2ZXJhZ2UnXSkKICAgICAgICAgICAgaWYgcmF0aW5nID09ICcnIG9yIHJhdGluZyA9PSBOb25lOiByYXRpbmcgPSAnMCcKICAgICAgICAgICAgcmF0aW5nID0gcmF0aW5nLmVuY29kZSgndXRmLTgnKQogICAgICAgICAgICBpZiBub3QgcmF0aW5nID09ICcwJzogc2VsZi5saXN0W2ldLnVwZGF0ZSh7J3JhdGluZyc6IHJhdGluZ30pCgogICAgICAgICAgICBwbG90ID0gaXRlbVsnc3VtbWFyeSddCiAgICAgICAgICAgIGlmIHBsb3QgPT0gJycgb3IgcGxvdCA9PSBOb25lOiBwbG90ID0gJzAnCiAgICAgICAgICAgIHBsb3QgPSByZS5zdWIoJ1xufDwuKz8+fDwvLis/PnwuKz8jXGQqOicsICcnLCBwbG90KQogICAgICAgICAgICBwbG90ID0gcGxvdC5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgaWYgbm90IHBsb3QgPT0gJzAnOiBzZWxmLmxpc3RbaV0udXBkYXRlKHsncGxvdCc6IHBsb3R9KQoKICAgICAgICAgICAgc2VsZi5tZXRhLmFwcGVuZCh7J2ltZGInOiBpbWRiLCAndG1kYic6ICcwJywgJ3R2ZGInOiB0dmRiLCAnbGFuZyc6IHNlbGYubGFuZywgJ2l0ZW0nOiB7J3R2c2hvd3RpdGxlJzogdHZzaG93dGl0bGUsICd5ZWFyJzogeWVhciwgJ2NvZGUnOiBpbWRiLCAnaW1kYic6IGltZGIsICd0dmRiJzogdHZkYiwgJ3N0dWRpbyc6IHN0dWRpbywgJ2dlbnJlJzogZ2VucmUsICdkdXJhdGlvbic6IGR1cmF0aW9uLCAncmF0aW5nJzogcmF0aW5nLCAncGxvdCc6IHBsb3R9fSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIGFkZERpcmVjdG9yeShzZWxmLCBpdGVtcywgcXVldWU9RmFsc2UpOgogICAgICAgIGlmIGl0ZW1zID09IE5vbmUgb3IgbGVuKGl0ZW1zKSA9PSAwOiByZXR1cm4KCiAgICAgICAgc3lzYWRkb24gPSBzeXMuYXJndlswXQogICAgICAgIGFkZG9uUG9zdGVyID0gYWRkb25CYW5uZXIgPSBjb250cm9sLmFkZG9uSW5mbygnaWNvbicpCiAgICAgICAgYWRkb25GYW5hcnQgPSBjb250cm9sLmFkZG9uSW5mbygnZmFuYXJ0JykKCiAgICAgICAgcGxheWxpc3QgPSBjb250cm9sLnBsYXlsaXN0CiAgICAgICAgaWYgbm90IHF1ZXVlID09IEZhbHNlOiBwbGF5bGlzdC5jbGVhcigpCgogICAgICAgIHRyeTogZGV2bW9kZSA9IFRydWUgaWYgJ3Rlc3RpbmdzLnhtbCcgaW4gY29udHJvbC5saXN0RGlyKGNvbnRyb2wuZGF0YVBhdGgpWzFdIGVsc2UgRmFsc2UKICAgICAgICBleGNlcHQ6IGRldm1vZGUgPSBGYWxzZQoKICAgICAgICBtb2RlID0gW2lbJ2NvbnRlbnQnXSBmb3IgaSBpbiBpdGVtcyBpZiAnY29udGVudCcgaW4gaV0KICAgICAgICBpZiAnbW92aWVzJyBpbiBtb2RlOiBtb2RlID0gJ21vdmllcycKICAgICAgICBlbGlmICd0dnNob3dzJyBpbiBtb2RlOiBtb2RlID0gJ3R2c2hvd3MnCiAgICAgICAgZWxpZiAnc2Vhc29ucycgaW4gbW9kZTogbW9kZSA9ICdzZWFzb25zJwogICAgICAgIGVsaWYgJ2VwaXNvZGVzJyBpbiBtb2RlOiBtb2RlID0gJ2VwaXNvZGVzJwogICAgICAgIGVsaWYgJ3ZpZGVvcycgaW4gbW9kZTogbW9kZSA9ICd2aWRlb3MnCiAgICAgICAgZWxzZTogbW9kZSA9ICdhZGRvbnMnCgogICAgICAgIGZvciBpIGluIGl0ZW1zOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeTogbmFtZSA9IGNvbnRyb2wubGFuZyhpbnQoaVsnbmFtZSddKSkuZW5jb2RlKCd1dGYtOCcpCiAgICAgICAgICAgICAgICBleGNlcHQ6IG5hbWUgPSBpWyduYW1lJ10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbmFtZSA9PSAnJzoKICAgICAgICAgICAgICAgICAgICBuYW1lID0gaVsnbmFtZSddCgogICAgICAgICAgICAgICAgdXJsID0gJyVzP2FjdGlvbj0lcycgJSAoc3lzYWRkb24sIGlbJ2FjdGlvbiddKQogICAgICAgICAgICAgICAgdHJ5OiB1cmwgKz0gJyZ1cmw9JXMnICUgdXJsbGliLnF1b3RlX3BsdXMoaVsndXJsJ10pCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgICAgIHRyeTogdXJsICs9ICcmY29udGVudD0lcycgJSB1cmxsaWIucXVvdGVfcGx1cyhpWydjb250ZW50J10pCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKCiAgICAgICAgICAgICAgICBpZiBpWydhY3Rpb24nXSA9PSAncGx1Z2luJyBhbmQgJ3VybCcgaW4gaTogdXJsID0gaVsndXJsJ10KCiAgICAgICAgICAgICAgICB0cnk6IGRldnVybCA9IGRpY3QodXJscGFyc2UucGFyc2VfcXNsKHVybHBhcnNlLnVybHBhcnNlKHVybCkucXVlcnkpKVsnYWN0aW9uJ10KICAgICAgICAgICAgICAgIGV4Y2VwdDogZGV2dXJsID0gTm9uZQogICAgICAgICAgICAgICAgaWYgZGV2dXJsID09ICdkZXZlbG9wZXInIGFuZCBub3QgZGV2bW9kZSA9PSBUcnVlOiByYWlzZSBFeGNlcHRpb24oKQoKICAgICAgICAgICAgICAgIHBvc3RlciA9IGlbJ3Bvc3RlciddIGlmICdwb3N0ZXInIGluIGkgZWxzZSAnMCcKICAgICAgICAgICAgICAgIGJhbm5lciA9IGlbJ2Jhbm5lciddIGlmICdiYW5uZXInIGluIGkgZWxzZSAnMCcKICAgICAgICAgICAgICAgIGZhbmFydCA9IGlbJ2ZhbmFydCddIGlmICdmYW5hcnQnIGluIGkgZWxzZSAnMCcKICAgICAgICAgICAgICAgIGlmIHBvc3RlciA9PSAnMCc6IHBvc3RlciA9IGFkZG9uUG9zdGVyCiAgICAgICAgICAgICAgICBpZiBiYW5uZXIgPT0gJzAnIGFuZCBwb3N0ZXIgPT0gJzAnOiBiYW5uZXIgPSBhZGRvbkJhbm5lcgogICAgICAgICAgICAgICAgZWxpZiBiYW5uZXIgPT0gJzAnOiBiYW5uZXIgPSBwb3N0ZXIKCiAgICAgICAgICAgICAgICBjb250ZW50ID0gaVsnY29udGVudCddIGlmICdjb250ZW50JyBpbiBpIGVsc2UgJzAnCgogICAgICAgICAgICAgICAgZm9sZGVyID0gaVsnZm9sZGVyJ10gaWYgJ2ZvbGRlcicgaW4gaSBlbHNlIFRydWUKCiAgICAgICAgICAgICAgICBtZXRhID0gZGljdCgoayx2KSBmb3IgaywgdiBpbiBpLml0ZXJpdGVtcygpIGlmIG5vdCB2ID09ICcwJykKCiAgICAgICAgICAgICAgICBjbSA9IFtdCgogICAgICAgICAgICAgICAgaWYgY29udGVudCBpbiBbJ21vdmllcycsICd0dnNob3dzJ106CiAgICAgICAgICAgICAgICAgICAgbWV0YS51cGRhdGUoeyd0cmFpbGVyJzogJyVzP2FjdGlvbj10cmFpbGVyJm5hbWU9JXMnICUgKHN5c2FkZG9uLCB1cmxsaWIucXVvdGVfcGx1cyhuYW1lKSl9KQogICAgICAgICAgICAgICAgICAgIGNtLmFwcGVuZCgoY29udHJvbC5sYW5nKDMwNzA3KS5lbmNvZGUoJ3V0Zi04JyksICdSdW5QbHVnaW4oJXM/YWN0aW9uPXRyYWlsZXImbmFtZT0lcyknICUgKHN5c2FkZG9uLCB1cmxsaWIucXVvdGVfcGx1cyhuYW1lKSkpKQoKICAgICAgICAgICAgICAgIGlmIGNvbnRlbnQgaW4gWydtb3ZpZXMnLCAndHZzaG93cycsICdzZWFzb25zJywgJ2VwaXNvZGVzJ106CiAgICAgICAgICAgICAgICAgICAgY20uYXBwZW5kKChjb250cm9sLmxhbmcoMzA3MDgpLmVuY29kZSgndXRmLTgnKSwgJ1hCTUMuQWN0aW9uKEluZm8pJykpCgogICAgICAgICAgICAgICAgaWYgKGZvbGRlciA9PSBGYWxzZSBhbmQgbm90ICd8cmVnZXg9JyBpbiBzdHIoaS5nZXQoJ3VybCcpKSkgb3IgKGZvbGRlciA9PSBUcnVlIGFuZCBjb250ZW50IGluIFsndHZzaG93cycsICdzZWFzb25zJ10pOgogICAgICAgICAgICAgICAgICAgIGNtLmFwcGVuZCgoY29udHJvbC5sYW5nKDMwNzIzKS5lbmNvZGUoJ3V0Zi04JyksICdSdW5QbHVnaW4oJXM/YWN0aW9uPXF1ZXVlSXRlbSknICUgc3lzYWRkb24pKQoKICAgICAgICAgICAgICAgIGlmIGNvbnRlbnQgPT0gJ21vdmllcyc6CiAgICAgICAgICAgICAgICAgICAgdHJ5OiBkZmlsZSA9ICclcyAoJXMpJyAlIChpWyd0aXRsZSddLCBpWyd5ZWFyJ10pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBkZmlsZSA9IG5hbWUKICAgICAgICAgICAgICAgICAgICB0cnk6IGNtLmFwcGVuZCgoY29udHJvbC5sYW5nKDMwNzIyKS5lbmNvZGUoJ3V0Zi04JyksICdSdW5QbHVnaW4oJXM/YWN0aW9uPWFkZERvd25sb2FkJm5hbWU9JXMmdXJsPSVzJmltYWdlPSVzKScgJSAoc3lzYWRkb24sIHVybGxpYi5xdW90ZV9wbHVzKGRmaWxlKSwgdXJsbGliLnF1b3RlX3BsdXMoaVsndXJsJ10pLCB1cmxsaWIucXVvdGVfcGx1cyhwb3N0ZXIpKSkpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgICAgICBlbGlmIGNvbnRlbnQgPT0gJ2VwaXNvZGVzJzoKICAgICAgICAgICAgICAgICAgICB0cnk6IGRmaWxlID0gJyVzIFMlMDJkRSUwMmQnICUgKGlbJ3R2c2hvd3RpdGxlJ10sIGludChpWydzZWFzb24nXSksIGludChpWydlcGlzb2RlJ10pKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogZGZpbGUgPSBuYW1lCiAgICAgICAgICAgICAgICAgICAgdHJ5OiBjbS5hcHBlbmQoKGNvbnRyb2wubGFuZygzMDcyMikuZW5jb2RlKCd1dGYtOCcpLCAnUnVuUGx1Z2luKCVzP2FjdGlvbj1hZGREb3dubG9hZCZuYW1lPSVzJnVybD0lcyZpbWFnZT0lcyknICUgKHN5c2FkZG9uLCB1cmxsaWIucXVvdGVfcGx1cyhkZmlsZSksIHVybGxpYi5xdW90ZV9wbHVzKGlbJ3VybCddKSwgdXJsbGliLnF1b3RlX3BsdXMocG9zdGVyKSkpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogcGFzcwogICAgICAgICAgICAgICAgZWxpZiBjb250ZW50ID09ICdzb25ncyc6CiAgICAgICAgICAgICAgICAgICAgdHJ5OiBjbS5hcHBlbmQoKGNvbnRyb2wubGFuZygzMDcyMikuZW5jb2RlKCd1dGYtOCcpLCAnUnVuUGx1Z2luKCVzP2FjdGlvbj1hZGREb3dubG9hZCZuYW1lPSVzJnVybD0lcyZpbWFnZT0lcyknICUgKHN5c2FkZG9uLCB1cmxsaWIucXVvdGVfcGx1cyhuYW1lKSwgdXJsbGliLnF1b3RlX3BsdXMoaVsndXJsJ10pLCB1cmxsaWIucXVvdGVfcGx1cyhwb3N0ZXIpKSkpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCgogICAgICAgICAgICAgICAgaWYgbW9kZSA9PSAnbW92aWVzJzoKICAgICAgICAgICAgICAgICAgICBjbS5hcHBlbmQoKGNvbnRyb2wubGFuZygzMDcxMSkuZW5jb2RlKCd1dGYtOCcpLCAnUnVuUGx1Z2luKCVzP2FjdGlvbj1hZGRWaWV3JmNvbnRlbnQ9bW92aWVzKScgJSBzeXNhZGRvbikpCiAgICAgICAgICAgICAgICBlbGlmIG1vZGUgPT0gJ3R2c2hvd3MnOgogICAgICAgICAgICAgICAgICAgIGNtLmFwcGVuZCgoY29udHJvbC5sYW5nKDMwNzEyKS5lbmNvZGUoJ3V0Zi04JyksICdSdW5QbHVnaW4oJXM/YWN0aW9uPWFkZFZpZXcmY29udGVudD10dnNob3dzKScgJSBzeXNhZGRvbikpCiAgICAgICAgICAgICAgICBlbGlmIG1vZGUgPT0gJ3NlYXNvbnMnOgogICAgICAgICAgICAgICAgICAgIGNtLmFwcGVuZCgoY29udHJvbC5sYW5nKDMwNzEzKS5lbmNvZGUoJ3V0Zi04JyksICdSdW5QbHVnaW4oJXM/YWN0aW9uPWFkZFZpZXcmY29udGVudD1zZWFzb25zKScgJSBzeXNhZGRvbikpCiAgICAgICAgICAgICAgICBlbGlmIG1vZGUgPT0gJ2VwaXNvZGVzJzoKICAgICAgICAgICAgICAgICAgICBjbS5hcHBlbmQoKGNvbnRyb2wubGFuZygzMDcxNCkuZW5jb2RlKCd1dGYtOCcpLCAnUnVuUGx1Z2luKCVzP2FjdGlvbj1hZGRWaWV3JmNvbnRlbnQ9ZXBpc29kZXMpJyAlIHN5c2FkZG9uKSkKCiAgICAgICAgICAgICAgICBpZiBkZXZtb2RlID09IFRydWU6CiAgICAgICAgICAgICAgICAgICAgdHJ5OiBjbS5hcHBlbmQoKCdPcGVuIGluIGJyb3dzZXInLCAnUnVuUGx1Z2luKCVzP2FjdGlvbj1icm93c2VyJnVybD0lcyknICUgKHN5c2FkZG9uLCB1cmxsaWIucXVvdGVfcGx1cyhpWyd1cmwnXSkpKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKCgogICAgICAgICAgICAgICAgaXRlbSA9IGNvbnRyb2wuaXRlbShsYWJlbD1uYW1lLCBpY29uSW1hZ2U9cG9zdGVyLCB0aHVtYm5haWxJbWFnZT1wb3N0ZXIpCgogICAgICAgICAgICAgICAgdHJ5OiBpdGVtLnNldEFydCh7J3Bvc3Rlcic6IHBvc3RlciwgJ3R2c2hvdy5wb3N0ZXInOiBwb3N0ZXIsICdzZWFzb24ucG9zdGVyJzogcG9zdGVyLCAnYmFubmVyJzogYmFubmVyLCAndHZzaG93LmJhbm5lcic6IGJhbm5lciwgJ3NlYXNvbi5iYW5uZXInOiBiYW5uZXJ9KQogICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCgogICAgICAgICAgICAgICAgaWYgbm90IGZhbmFydCA9PSAnMCc6CiAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXRQcm9wZXJ0eSgnRmFuYXJ0X0ltYWdlJywgZmFuYXJ0KQogICAgICAgICAgICAgICAgZWxpZiBub3QgYWRkb25GYW5hcnQgPT0gTm9uZToKICAgICAgICAgICAgICAgICAgICBpdGVtLnNldFByb3BlcnR5KCdGYW5hcnRfSW1hZ2UnLCBhZGRvbkZhbmFydCkKCiAgICAgICAgICAgICAgICBpZiBxdWV1ZSA9PSBGYWxzZToKICAgICAgICAgICAgICAgICAgICBpdGVtLnNldEluZm8odHlwZT0nVmlkZW8nLCBpbmZvTGFiZWxzID0gbWV0YSkKICAgICAgICAgICAgICAgICAgICBpdGVtLmFkZENvbnRleHRNZW51SXRlbXMoY20pCiAgICAgICAgICAgICAgICAgICAgY29udHJvbC5hZGRJdGVtKGhhbmRsZT1pbnQoc3lzLmFyZ3ZbMV0pLCB1cmw9dXJsLCBsaXN0aXRlbT1pdGVtLCBpc0ZvbGRlcj1mb2xkZXIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGl0ZW0uc2V0SW5mbyh0eXBlPSdWaWRlbycsIGluZm9MYWJlbHMgPSBtZXRhKQogICAgICAgICAgICAgICAgICAgIHBsYXlsaXN0LmFkZCh1cmw9dXJsLCBsaXN0aXRlbT1pdGVtKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGlmIG5vdCBxdWV1ZSA9PSBGYWxzZToKICAgICAgICAgICAgcmV0dXJuIGNvbnRyb2wucGxheWVyLnBsYXkocGxheWxpc3QpCgogICAgICAgIHRyeToKICAgICAgICAgICAgaSA9IGl0ZW1zWzBdCiAgICAgICAgICAgIGlmIGlbJ25leHQnXSA9PSAnJzogcmFpc2UgRXhjZXB0aW9uKCkKICAgICAgICAgICAgdXJsID0gJyVzP2FjdGlvbj0lcyZ1cmw9JXMnICUgKHN5c2FkZG9uLCBpWyduZXh0YWN0aW9uJ10sIHVybGxpYi5xdW90ZV9wbHVzKGlbJ25leHQnXSkpCiAgICAgICAgICAgIGl0ZW0gPSBjb250cm9sLml0ZW0obGFiZWw9Y29udHJvbC5sYW5nKDMwNTAwKS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIGl0ZW0uc2V0QXJ0KHsnYWRkb25Qb3N0ZXInOiBhZGRvblBvc3RlciwgJ3RodW1iJzogYWRkb25Qb3N0ZXIsICdwb3N0ZXInOiBhZGRvblBvc3RlciwgJ3R2c2hvdy5wb3N0ZXInOiBhZGRvblBvc3RlciwgJ3NlYXNvbi5wb3N0ZXInOiBhZGRvblBvc3RlciwgJ2Jhbm5lcic6IGFkZG9uUG9zdGVyLCAndHZzaG93LmJhbm5lcic6IGFkZG9uUG9zdGVyLCAnc2Vhc29uLmJhbm5lcic6IGFkZG9uUG9zdGVyfSkKICAgICAgICAgICAgaXRlbS5zZXRQcm9wZXJ0eSgnYWRkb25GYW5hcnRfSW1hZ2UnLCBhZGRvbkZhbmFydCkKICAgICAgICAgICAgY29udHJvbC5hZGRJdGVtKGhhbmRsZT1pbnQoc3lzLmFyZ3ZbMV0pLCB1cmw9dXJsLCBsaXN0aXRlbT1pdGVtLCBpc0ZvbGRlcj1UcnVlKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBpZiBub3QgbW9kZSA9PSBOb25lOiBjb250cm9sLmNvbnRlbnQoaW50KHN5cy5hcmd2WzFdKSwgbW9kZSkKICAgICAgICBjb250cm9sLmRpcmVjdG9yeShpbnQoc3lzLmFyZ3ZbMV0pLCBjYWNoZVRvRGlzYz1UcnVlKQogICAgICAgIGlmIG1vZGUgaW4gWydtb3ZpZXMnLCAndHZzaG93cycsICdzZWFzb25zJywgJ2VwaXNvZGVzJ106CiAgICAgICAgICAgIHZpZXdzLnNldFZpZXcobW9kZSwgeydza2luLmVzdHVhcnknOiA1NX0pCgoKCmNsYXNzIHJlc29sdmVyOgogICAgZGVmIGJyb3dzZXIoc2VsZiwgdXJsKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVybCA9IHNlbGYuZ2V0KHVybCkKICAgICAgICAgICAgaWYgdXJsID09IEZhbHNlOiByZXR1cm4KICAgICAgICAgICAgY29udHJvbC5leGVjdXRlKCdSdW5QbHVnaW4ocGx1Z2luOi8vcGx1Z2luLnByb2dyYW0uY2hyb21lLmxhdW5jaGVyLz91cmw9JXMmbW9kZT1zaG93U2l0ZSZzdG9wUGxheWJhY2s9bm8pJyAlIHVybGxpYi5xdW90ZV9wbHVzKHVybCkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgoKICAgIGRlZiBsaW5rKHNlbGYsIHVybCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB1cmwgPSBzZWxmLmdldCh1cmwpCiAgICAgICAgICAgIGlmIHVybCA9PSBGYWxzZTogcmV0dXJuCgogICAgICAgICAgICBjb250cm9sLmV4ZWN1dGUoJ0FjdGl2YXRlV2luZG93KGJ1c3lkaWFsb2cpJykKICAgICAgICAgICAgdXJsID0gc2VsZi5wcm9jZXNzKHVybCkKICAgICAgICAgICAgY29udHJvbC5leGVjdXRlKCdEaWFsb2cuQ2xvc2UoYnVzeWRpYWxvZyknKQoKICAgICAgICAgICAgaWYgdXJsID09IE5vbmU6IHJldHVybiBjb250cm9sLmluZm9EaWFsb2coY29udHJvbC5sYW5nKDMwNzA1KS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIHJldHVybiB1cmwKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIGdldChzZWxmLCB1cmwpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaXRlbXMgPSByZS5jb21waWxlKCc8c3VibGluayg/OlxzK25hbWU9fCkoPzpcJ3xcInwpKC4qPykoPzpcJ3xcInwpPiguKz8pPC9zdWJsaW5rPicpLmZpbmRhbGwodXJsKQoKICAgICAgICAgICAgaWYgbGVuKGl0ZW1zKSA9PSAwOiByZXR1cm4gdXJsCiAgICAgICAgICAgIGlmIGxlbihpdGVtcykgPT0gMTogcmV0dXJuIGl0ZW1zWzBdWzFdCgogICAgICAgICAgICBpdGVtcyA9IFsoJ0xpbmsgJXMnICUgKGludChpdGVtcy5pbmRleChpKSkrMSkgaWYgaVswXSA9PSAnJyBlbHNlIGlbMF0sIGlbMV0pIGZvciBpIGluIGl0ZW1zXQoKICAgICAgICAgICAgc2VsZWN0ID0gY29udHJvbC5zZWxlY3REaWFsb2coW2lbMF0gZm9yIGkgaW4gaXRlbXNdLCBjb250cm9sLmluZm9MYWJlbCgnbGlzdGl0ZW0ubGFiZWwnKSkKCiAgICAgICAgICAgIGlmIHNlbGVjdCA9PSAtMTogcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6IHJldHVybiBpdGVtc1tzZWxlY3RdWzFdCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgoKICAgIGRlZiBmNG0oc2VsZiwgdXJsLCBuYW1lKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgbm90IGFueShpIGluIHVybCBmb3IgaSBpbiBbJy5mNG0nLCAnLnRzJ10pOiByYWlzZSBFeGNlcHRpb24oKQogICAgICAgICAgICAgICAgZXh0ID0gdXJsLnNwbGl0KCc/JylbMF0uc3BsaXQoJyYnKVswXS5zcGxpdCgnfCcpWzBdLnJzcGxpdCgnLicpWy0xXS5yZXBsYWNlKCcvJywgJycpLmxvd2VyKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBleHQgaW4gWydmNG0nLCAndHMnXTogcmFpc2UgRXhjZXB0aW9uKCkKCiAgICAgICAgICAgICAgICBwYXJhbXMgPSB1cmxwYXJzZS5wYXJzZV9xcyh1cmwpCgogICAgICAgICAgICAgICAgdHJ5OiBwcm94eSA9IHBhcmFtc1sncHJveHknXVswXQogICAgICAgICAgICAgICAgZXhjZXB0OiBwcm94eSA9IE5vbmUKCiAgICAgICAgICAgICAgICB0cnk6IHByb3h5X3VzZV9jaHVua3MgPSBqc29uLmxvYWRzKHBhcmFtc1sncHJveHlfZm9yX2NodW5rcyddWzBdKQogICAgICAgICAgICAgICAgZXhjZXB0OiBwcm94eV91c2VfY2h1bmtzID0gVHJ1ZQoKICAgICAgICAgICAgICAgIHRyeTogbWF4Yml0cmF0ZSA9IGludChwYXJhbXNbJ21heGJpdHJhdGUnXVswXSkKICAgICAgICAgICAgICAgIGV4Y2VwdDogbWF4Yml0cmF0ZSA9IDAKCiAgICAgICAgICAgICAgICB0cnk6IHNpbXBsZURvd25sb2FkZXIgPSBqc29uLmxvYWRzKHBhcmFtc1snc2ltcGxlZG93bmxvYWRlciddWzBdKQogICAgICAgICAgICAgICAgZXhjZXB0OiBzaW1wbGVEb3dubG9hZGVyID0gRmFsc2UKCiAgICAgICAgICAgICAgICB0cnk6IGF1dGhfc3RyaW5nID0gcGFyYW1zWydhdXRoJ11bMF0KICAgICAgICAgICAgICAgIGV4Y2VwdDogYXV0aF9zdHJpbmcgPSAnJwoKICAgICAgICAgICAgICAgIHRyeTogc3RyZWFtdHlwZSA9IHBhcmFtc1snc3RyZWFtdHlwZSddWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IHN0cmVhbXR5cGUgPSAnVFNET1dOTE9BREVSJyBpZiBleHQgPT0gJ3RzJyBlbHNlICdIRFMnCgogICAgICAgICAgICAgICAgdHJ5OiBzd2YgPSBwYXJhbXNbJ3N3ZiddWzBdCiAgICAgICAgICAgICAgICBleGNlcHQ6IHN3ZiA9IE5vbmUKCiAgICAgICAgICAgICAgICBmcm9tIEY0bVByb3h5IGltcG9ydCBmNG1Qcm94eUhlbHBlcgogICAgICAgICAgICAgICAgcmV0dXJuIGY0bVByb3h5SGVscGVyKCkucGxheUY0bUxpbmsodXJsLCBuYW1lLCBwcm94eSwgcHJveHlfdXNlX2NodW5rcywgbWF4Yml0cmF0ZSwgc2ltcGxlRG93bmxvYWRlciwgYXV0aF9zdHJpbmcsIHN0cmVhbXR5cGUsIEZhbHNlLCBzd2YpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIHByb2Nlc3Moc2VsZiwgdXJsLCBkaXJlY3Q9VHJ1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgYW55KGkgaW4gdXJsIGZvciBpIGluIFsnLmpwZycsICcucG5nJywgJy5naWYnXSk6IHJhaXNlIEV4Y2VwdGlvbigpCiAgICAgICAgICAgIGV4dCA9IHVybC5zcGxpdCgnPycpWzBdLnNwbGl0KCcmJylbMF0uc3BsaXQoJ3wnKVswXS5yc3BsaXQoJy4nKVstMV0ucmVwbGFjZSgnLycsICcnKS5sb3dlcigpCiAgICAgICAgICAgIGlmIG5vdCBleHQgaW4gWydqcGcnLCAncG5nJywgJ2dpZiddOiByYWlzZSBFeGNlcHRpb24oKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpID0gb3MucGF0aC5qb2luKGNvbnRyb2wuZGF0YVBhdGgsJ2ltZycpCiAgICAgICAgICAgICAgICBjb250cm9sLmRlbGV0ZUZpbGUoaSkKICAgICAgICAgICAgICAgIGYgPSBjb250cm9sLm9wZW5GaWxlKGksICd3JykKICAgICAgICAgICAgICAgIGYud3JpdGUoY2xpZW50LnJlcXVlc3QodXJsKSkKICAgICAgICAgICAgICAgIGYuY2xvc2UoKQogICAgICAgICAgICAgICAgY29udHJvbC5leGVjdXRlKCdTaG93UGljdHVyZSgiJXMiKScgJSBpKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHIsIHggPSByZS5maW5kYWxsKCcoLis/KVx8cmVnZXg9KC4rPykkJywgdXJsKVswXQogICAgICAgICAgICB4ID0gcmVnZXguZmV0Y2goeCkKICAgICAgICAgICAgciArPSB1cmxsaWIudW5xdW90ZV9wbHVzKHgpCiAgICAgICAgICAgIGlmIG5vdCAnPC9yZWdleD4nIGluIHI6IHJhaXNlIEV4Y2VwdGlvbigpCiAgICAgICAgICAgIHUgPSByZWdleC5yZXNvbHZlKHIpCiAgICAgICAgICAgIGlmIG5vdCB1ID09IE5vbmU6IHVybCA9IHUKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgdXJsLnN0YXJ0c3dpdGgoJ3J0bXAnKTogcmFpc2UgRXhjZXB0aW9uKCkKICAgICAgICAgICAgaWYgbGVuKHJlLmNvbXBpbGUoJ1xzKnRpbWVvdXQ9KFxkKiknKS5maW5kYWxsKHVybCkpID09IDA6IHVybCArPSAnIHRpbWVvdXQ9MTAnCiAgICAgICAgICAgIHJldHVybiB1cmwKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgYW55KGkgaW4gdXJsIGZvciBpIGluIFsnLm0zdTgnLCAnLmY0bScsICcudHMnXSk6IHJhaXNlIEV4Y2VwdGlvbigpCiAgICAgICAgICAgIGV4dCA9IHVybC5zcGxpdCgnPycpWzBdLnNwbGl0KCcmJylbMF0uc3BsaXQoJ3wnKVswXS5yc3BsaXQoJy4nKVstMV0ucmVwbGFjZSgnLycsICcnKS5sb3dlcigpCiAgICAgICAgICAgIGlmIG5vdCBleHQgaW4gWydtM3U4JywgJ2Y0bScsICd0cyddOiByYWlzZSBFeGNlcHRpb24oKQogICAgICAgICAgICByZXR1cm4gdXJsCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgICAgIHRyeToKICAgICAgICAgICAgcHJlc2V0ID0gcmUuZmluZGFsbCgnPHByZXNldD4oLis/KTwvcHJlc2V0PicsIHVybClbMF0KCiAgICAgICAgICAgIGlmIG5vdCAnc2VhcmNoJyBpbiBwcmVzZXQ6IHJhaXNlIEV4Y2VwdGlvbigpCgogICAgICAgICAgICB0aXRsZSwgeWVhciwgaW1kYiA9IHJlLmZpbmRhbGwoJzx0aXRsZT4oLis/KTwvdGl0bGU+JywgdXJsKVswXSwgcmUuZmluZGFsbCgnPHllYXI+KC4rPyk8L3llYXI+JywgdXJsKVswXSwgcmUuZmluZGFsbCgnPGltZGI+KC4rPyk8L2ltZGI+JywgdXJsKVswXQoKICAgICAgICAgICAgdHJ5OiB0dmRiLCB0dnNob3d0aXRsZSwgcHJlbWllcmVkLCBzZWFzb24sIGVwaXNvZGUgPSByZS5maW5kYWxsKCc8dHZkYj4oLis/KTwvdHZkYj4nLCB1cmwpWzBdLCByZS5maW5kYWxsKCc8dHZzaG93dGl0bGU+KC4rPyk8L3R2c2hvd3RpdGxlPicsIHVybClbMF0sIHJlLmZpbmRhbGwoJzxwcmVtaWVyZWQ+KC4rPyk8L3ByZW1pZXJlZD4nLCB1cmwpWzBdLCByZS5maW5kYWxsKCc8c2Vhc29uPiguKz8pPC9zZWFzb24+JywgdXJsKVswXSwgcmUuZmluZGFsbCgnPGVwaXNvZGU+KC4rPyk8L2VwaXNvZGU+JywgdXJsKVswXQogICAgICAgICAgICBleGNlcHQ6IHR2ZGIgPSB0dnNob3d0aXRsZSA9IHByZW1pZXJlZCA9IHNlYXNvbiA9IGVwaXNvZGUgPSBOb25lCgogICAgICAgICAgICBkaXJlY3QgPSBGYWxzZQoKICAgICAgICAgICAgcXVhbGl0eSA9ICdIRCcgaWYgbm90IHByZXNldCA9PSAnc2VhcmNoc2QnIGVsc2UgJ1NEJwoKICAgICAgICAgICAgZnJvbSByZXNvdXJjZXMubGliLm1vZHVsZXMgaW1wb3J0IHNvdXJjZXMKCiAgICAgICAgICAgIHUgPSBzb3VyY2VzLnNvdXJjZXMoKS5nZXRTb3VyY2VzKHRpdGxlLCB5ZWFyLCBpbWRiLCB0dmRiLCBzZWFzb24sIGVwaXNvZGUsIHR2c2hvd3RpdGxlLCBwcmVtaWVyZWQsIHF1YWxpdHkpCgogICAgICAgICAgICBpZiBub3QgdSA9PSBOb25lOiByZXR1cm4gdQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gcmVzb3VyY2VzLmxpYi5tb2R1bGVzIGltcG9ydCBzb3VyY2VzCgogICAgICAgICAgICB1ID0gc291cmNlcy5zb3VyY2VzKCkuZ2V0VVJJU291cmNlKHVybCkKCiAgICAgICAgICAgIGlmIG5vdCB1ID09IEZhbHNlOiBkaXJlY3QgPSBGYWxzZQogICAgICAgICAgICBpZiB1ID09IE5vbmUgb3IgdSA9PSBGYWxzZTogcmFpc2UgRXhjZXB0aW9uKCkKCiAgICAgICAgICAgIHJldHVybiB1CiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90ICcuZ29vZ2xlLmNvbScgaW4gdXJsOiByYWlzZSBFeGNlcHRpb24oKQogICAgICAgICAgICBmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgZGlyZWN0c3RyZWFtCiAgICAgICAgICAgIHUgPSBkaXJlY3RzdHJlYW0uZ29vZ2xlKHVybClbMF1bJ3VybCddCiAgICAgICAgICAgIHJldHVybiB1CiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90ICdmaWxtb24uY29tLycgaW4gdXJsOiByYWlzZSBFeGNlcHRpb24oKQogICAgICAgICAgICBmcm9tIHJlc291cmNlcy5saWIubW9kdWxlcyBpbXBvcnQgZmlsbW9uCiAgICAgICAgICAgIHUgPSBmaWxtb24ucmVzb2x2ZSh1cmwpCiAgICAgICAgICAgIHJldHVybiB1CiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgICAgIHRyeToKICAgICAgICAgICAgdHJ5OiBoZWFkZXJzID0gZGljdCh1cmxwYXJzZS5wYXJzZV9xc2wodXJsLnJzcGxpdCgnfCcsIDEpWzFdKSkKICAgICAgICAgICAgZXhjZXB0OiBoZWFkZXJzID0gZGljdCgnJykKICAgICAgICAgICAgaWYgbm90IHVybC5zdGFydHN3aXRoKCdodHRwJyk6IHJhaXNlIEV4Y2VwdGlvbigpCiAgICAgICAgICAgIHJlc3VsdCA9IGNsaWVudC5yZXF1ZXN0KHVybC5zcGxpdCgnfCcpWzBdLCBoZWFkZXJzPWhlYWRlcnMsIG91dHB1dD0naGVhZGVycycsIHRpbWVvdXQ9JzIwJykKICAgICAgICAgICAgaWYgJ0NvbnRlbnQtVHlwZScgaW4gcmVzdWx0IGFuZCBub3QgJ2h0bWwnIGluIHJlc3VsdFsnQ29udGVudC1UeXBlJ106IHJhaXNlIEV4Y2VwdGlvbigpCgogICAgICAgICAgICBpbXBvcnQgbGl2ZXJlc29sdmVyCiAgICAgICAgICAgIGlmIGxpdmVyZXNvbHZlci5pc1ZhbGlkKHVybCkgPT0gVHJ1ZTogZGlyZWN0ID0gRmFsc2UKICAgICAgICAgICAgdSA9IGxpdmVyZXNvbHZlci5yZXNvbHZlKHVybCkKCiAgICAgICAgICAgIGlmIG5vdCB1ID09IE5vbmU6CiAgICAgICAgICAgICAgICB0cnk6IGRpYWxvZy5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgICAgIHJldHVybiB1CiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgkJCQogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHVybHJlc29sdmVyCgogICAgICAgICAgICBobWYgPSB1cmxyZXNvbHZlci5Ib3N0ZWRNZWRpYUZpbGUodXJsPXVybCkKCiAgICAgICAgICAgIGlmIGhtZi52YWxpZF91cmwoKSA9PSBGYWxzZTogcmFpc2UgRXhjZXB0aW9uKCkKCiAgICAgICAgICAgIGRpcmVjdCA9IEZhbHNlIDsgdSA9IGhtZi5yZXNvbHZlKCkKCiAgICAgICAgICAgIGlmIG5vdCB1ID09IEZhbHNlOiByZXR1cm4gdQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBpZiBkaXJlY3QgPT0gVHJ1ZTogcmV0dXJuIHVybAoKCmNsYXNzIHBsYXllcih4Ym1jLlBsYXllcik6CiAgICBkZWYgX19pbml0X18gKHNlbGYpOgogICAgICAgIHhibWMuUGxheWVyLl9faW5pdF9fKHNlbGYpCgoKICAgIGRlZiBwbGF5MyhzZWxmLCB1cmwsIGNvbnRlbnQ9Tm9uZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBiYXNlID0gdXJsCgogICAgICAgICAgICB1cmwgPSByZXNvbHZlcigpLmdldCh1cmwpCiAgICAgICAgICAgIGlmIHVybCA9PSBGYWxzZTogcmV0dXJuCgogICAgICAgICAgICBjb250cm9sLmV4ZWN1dGUoJ0FjdGl2YXRlV2luZG93KGJ1c3lkaWFsb2cpJykKICAgICAgICAgICAgdXJsID0gcmVzb2x2ZXIoKS5wcm9jZXNzKHVybCkKICAgICAgICAgICAgY29udHJvbC5leGVjdXRlKCdEaWFsb2cuQ2xvc2UoYnVzeWRpYWxvZyknKQoKICAgICAgICAgICAgaWYgdXJsID09IE5vbmU6IHJldHVybiBjb250cm9sLmluZm9EaWFsb2coY29udHJvbC5sYW5nKDMwNzA1KS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIGlmIHVybCA9PSBGYWxzZTogcmV0dXJuCgogICAgICAgICAgICBtZXRhID0ge30KICAgICAgICAgICAgZm9yIGkgaW4gWyd0aXRsZScsICdvcmlnaW5hbHRpdGxlJywgJ3R2c2hvd3RpdGxlJywgJ3llYXInLCAnc2Vhc29uJywgJ2VwaXNvZGUnLCAnZ2VucmUnLCAncmF0aW5nJywgJ3ZvdGVzJywgJ2RpcmVjdG9yJywgJ3dyaXRlcicsICdwbG90JywgJ3RhZ2xpbmUnXToKICAgICAgICAgICAgICAgIHRyeTogbWV0YVtpXSA9IGNvbnRyb2wuaW5mb0xhYmVsKCdsaXN0aXRlbS4lcycgJSBpKQogICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIG1ldGEgPSBkaWN0KChrLHYpIGZvciBrLCB2IGluIG1ldGEuaXRlcml0ZW1zKCkgaWYgbm90IHYgPT0gJycpCiAgICAgICAgICAgIGlmIG5vdCAndGl0bGUnIGluIG1ldGE6IG1ldGFbJ3RpdGxlJ10gPSBjb250cm9sLmluZm9MYWJlbCgnbGlzdGl0ZW0ubGFiZWwnKQogICAgICAgICAgICBpY29uID0gY29udHJvbC5pbmZvTGFiZWwoJ2xpc3RpdGVtLmljb24nKQoKCiAgICAgICAgICAgIHNlbGYubmFtZSA9IG1ldGFbJ3RpdGxlJ10gOyBzZWxmLnllYXIgPSBtZXRhWyd5ZWFyJ10gaWYgJ3llYXInIGluIG1ldGEgZWxzZSAnMCcKCiAgICAgICAgICAgIHNlbGYuZ2V0Ym9va21hcmsgPSBUcnVlIGlmIChjb250ZW50ID09ICdtb3ZpZXMnIG9yIGNvbnRlbnQgPT0gJ2VwaXNvZGVzJykgZWxzZSBGYWxzZQoKICAgICAgICAgICAgc2VsZi5vZmZzZXQgPSBib29rbWFya3MoKS5nZXQoc2VsZi5uYW1lLCBzZWxmLnllYXIpCgogICAgICAgICAgICBmNG0gPSByZXNvbHZlcigpLmY0bSh1cmwsIHNlbGYubmFtZSkKICAgICAgICAgICAgaWYgbm90IGY0bSA9PSBOb25lOiByZXR1cm4KCgogICAgICAgICAgICBpdGVtID0gY29udHJvbC5pdGVtKHBhdGg9dXJsLCBpY29uSW1hZ2U9aWNvbiwgdGh1bWJuYWlsSW1hZ2U9aWNvbikKICAgICAgICAgICAgdHJ5OiBpdGVtLnNldEFydCh7J2ljb24nOiBpY29ufSkKICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIGl0ZW0uc2V0SW5mbyh0eXBlPSdWaWRlbycsIGluZm9MYWJlbHMgPSBtZXRhKQogICAgICAgICAgICBjb250cm9sLnBsYXllci5wbGF5KHVybCwgaXRlbSkKICAgICAgICAgICAgY29udHJvbC5yZXNvbHZlKGludChzeXMuYXJndlsxXSksIFRydWUsIGl0ZW0pCgogICAgICAgICAgICBzZWxmLnRvdGFsVGltZSA9IDAgOyBzZWxmLmN1cnJlbnRUaW1lID0gMAoKICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMCwgMjQwKToKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNQbGF5aW5nVmlkZW8oKTogYnJlYWsKICAgICAgICAgICAgICAgIGNvbnRyb2wuc2xlZXAoMTAwMCkKICAgICAgICAgICAgd2hpbGUgc2VsZi5pc1BsYXlpbmdWaWRlbygpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYudG90YWxUaW1lID0gc2VsZi5nZXRUb3RhbFRpbWUoKQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudFRpbWUgPSBzZWxmLmdldFRpbWUoKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGNvbnRyb2wuc2xlZXAoMjAwMCkKICAgICAgICAgICAgY29udHJvbC5zbGVlcCg1MDAwKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKCiAgICBkZWYgb25QbGF5QmFja1N0YXJ0ZWQoc2VsZik6CiAgICAgICAgY29udHJvbC5leGVjdXRlKCdEaWFsb2cuQ2xvc2UoYWxsLHRydWUpJykKICAgICAgICBpZiBzZWxmLmdldGJvb2ttYXJrID09IFRydWUgYW5kIG5vdCBzZWxmLm9mZnNldCA9PSAnMCc6CiAgICAgICAgICAgIHNlbGYuc2Vla1RpbWUoZmxvYXQoc2VsZi5vZmZzZXQpKQoKCiAgICBkZWYgb25QbGF5QmFja1N0b3BwZWQoc2VsZik6CiAgICAgICAgaWYgc2VsZi5nZXRib29rbWFyayA9PSBUcnVlOgogICAgICAgICAgICBib29rbWFya3MoKS5yZXNldChzZWxmLmN1cnJlbnRUaW1lLCBzZWxmLnRvdGFsVGltZSwgc2VsZi5uYW1lLCBzZWxmLnllYXIpCgoKICAgIGRlZiBvblBsYXlCYWNrRW5kZWQoc2VsZik6CiAgICAgICAgc2VsZi5vblBsYXlCYWNrU3RvcHBlZCgpCgoKCmNsYXNzIGJvb2ttYXJrczoKICAgIGRlZiBnZXQoc2VsZiwgbmFtZSwgeWVhcj0nMCcpOgogICAgICAgIHRyeToKICAgICAgICAgICAgb2Zmc2V0ID0gJzAnCgogICAgICAgICAgICAjaWYgbm90IGNvbnRyb2wuc2V0dGluZygnYm9va21hcmtzJykgPT0gJ3RydWUnOiByYWlzZSBFeGNlcHRpb24oKQoKICAgICAgICAgICAgaWRGaWxlID0gaGFzaGxpYi5tZDUoKQogICAgICAgICAgICBmb3IgaSBpbiBuYW1lOiBpZEZpbGUudXBkYXRlKHN0cihpKSkKICAgICAgICAgICAgZm9yIGkgaW4geWVhcjogaWRGaWxlLnVwZGF0ZShzdHIoaSkpCiAgICAgICAgICAgIGlkRmlsZSA9IHN0cihpZEZpbGUuaGV4ZGlnZXN0KCkpCgogICAgICAgICAgICBkYmNvbiA9IGRhdGFiYXNlLmNvbm5lY3QoY29udHJvbC5ib29rbWFya3NGaWxlKQogICAgICAgICAgICBkYmN1ciA9IGRiY29uLmN1cnNvcigpCiAgICAgICAgICAgIGRiY3VyLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYm9va21hcmsgV0hFUkUgaWRGaWxlID0gJyVzJyIgJSBpZEZpbGUpCiAgICAgICAgICAgIG1hdGNoID0gZGJjdXIuZmV0Y2hvbmUoKQogICAgICAgICAgICBzZWxmLm9mZnNldCA9IHN0cihtYXRjaFsxXSkKICAgICAgICAgICAgZGJjb24uY29tbWl0KCkKCiAgICAgICAgICAgIGlmIHNlbGYub2Zmc2V0ID09ICcwJzogcmFpc2UgRXhjZXB0aW9uKCkKCiAgICAgICAgICAgIG1pbnV0ZXMsIHNlY29uZHMgPSBkaXZtb2QoZmxvYXQoc2VsZi5vZmZzZXQpLCA2MCkgOyBob3VycywgbWludXRlcyA9IGRpdm1vZChtaW51dGVzLCA2MCkKICAgICAgICAgICAgbGFiZWwgPSAnJTAyZDolMDJkOiUwMmQnICUgKGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzKQogICAgICAgICAgICBsYWJlbCA9IChjb250cm9sLmxhbmcoMzI1MDIpICUgbGFiZWwpLmVuY29kZSgndXRmLTgnKQoKICAgICAgICAgICAgdHJ5OiB5ZXMgPSBjb250cm9sLmRpYWxvZy5jb250ZXh0bWVudShbbGFiZWwsIGNvbnRyb2wubGFuZygzMjUwMSkuZW5jb2RlKCd1dGYtOCcpLCBdKQogICAgICAgICAgICBleGNlcHQ6IHllcyA9IGNvbnRyb2wueWVzbm9EaWFsb2cobGFiZWwsICcnLCAnJywgc3RyKG5hbWUpLCBjb250cm9sLmxhbmcoMzI1MDMpLmVuY29kZSgndXRmLTgnKSwgY29udHJvbC5sYW5nKDMyNTAxKS5lbmNvZGUoJ3V0Zi04JykpCgogICAgICAgICAgICBpZiB5ZXM6IHNlbGYub2Zmc2V0ID0gJzAnCgogICAgICAgICAgICByZXR1cm4gc2VsZi5vZmZzZXQKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBvZmZzZXQKCgogICAgZGVmIHJlc2V0KHNlbGYsIGN1cnJlbnRUaW1lLCB0b3RhbFRpbWUsIG5hbWUsIHllYXI9JzAnKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICNpZiBub3QgY29udHJvbC5zZXR0aW5nKCdib29rbWFya3MnKSA9PSAndHJ1ZSc6IHJhaXNlIEV4Y2VwdGlvbigpCgogICAgICAgICAgICB0aW1lSW5TZWNvbmRzID0gc3RyKGN1cnJlbnRUaW1lKQogICAgICAgICAgICBvayA9IGludChjdXJyZW50VGltZSkgPiAxODAgYW5kIChjdXJyZW50VGltZSAvIHRvdGFsVGltZSkgPD0gLjkyCgogICAgICAgICAgICBpZEZpbGUgPSBoYXNobGliLm1kNSgpCiAgICAgICAgICAgIGZvciBpIGluIG5hbWU6IGlkRmlsZS51cGRhdGUoc3RyKGkpKQogICAgICAgICAgICBmb3IgaSBpbiB5ZWFyOiBpZEZpbGUudXBkYXRlKHN0cihpKSkKICAgICAgICAgICAgaWRGaWxlID0gc3RyKGlkRmlsZS5oZXhkaWdlc3QoKSkKCiAgICAgICAgICAgIGNvbnRyb2wubWFrZUZpbGUoY29udHJvbC5kYXRhUGF0aCkKICAgICAgICAgICAgZGJjb24gPSBkYXRhYmFzZS5jb25uZWN0KGNvbnRyb2wuYm9va21hcmtzRmlsZSkKICAgICAgICAgICAgZGJjdXIgPSBkYmNvbi5jdXJzb3IoKQogICAgICAgICAgICBkYmN1ci5leGVjdXRlKCJDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBib29rbWFyayAoIiJpZEZpbGUgVEVYVCwgIiJ0aW1lSW5TZWNvbmRzIFRFWFQsICIiVU5JUVVFKGlkRmlsZSkiIik7IikKICAgICAgICAgICAgZGJjdXIuZXhlY3V0ZSgiREVMRVRFIEZST00gYm9va21hcmsgV0hFUkUgaWRGaWxlID0gJyVzJyIgJSBpZEZpbGUpCiAgICAgICAgICAgIGlmIG9rOiBkYmN1ci5leGVjdXRlKCJJTlNFUlQgSU5UTyBib29rbWFyayBWYWx1ZXMgKD8sID8pIiwgKGlkRmlsZSwgdGltZUluU2Vjb25kcykpCiAgICAgICAgICAgIGRiY29uLmNvbW1pdCgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgo=')
